<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –¢–∞–π–º-—Ç—Ä–µ–∫–µ—Ä</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
 /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) */
:root {
  --bg: #0b1220;
  --panel: rgba(255,255,255,0.06);
  --panel-2: rgba(255,255,255,0.08);
  --border: rgba(255,255,255,0.10);
  --text: rgba(255,255,255,0.92);
  --muted: rgba(255,255,255,0.60);
  --muted-2: rgba(255,255,255,0.45);
  --accent: #4a90e2;
  --accent-2: #6aa8ff;
  --ok: #2dcc70;
  --bad: #ff4d4d;
  --warn: #ffd166;
  --shadow: 0 12px 30px rgba(0,0,0,0.35);
  --shadow-soft: 0 8px 20px rgba(0,0,0,0.22);
  --radius: 16px;
  --radius-sm: 12px;
  --radius-xs: 10px;
  --focus: 0 0 0 3px rgba(74,144,226,0.35);
}
/* –°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞ */
[data-theme="light"] {
  --bg: #f0f2f5;
  --panel: rgba(255, 255, 255, 0.88);
  --panel-2: rgba(255, 255, 255, 0.75);
  --border: rgba(0, 0, 0, 0.10);
  --text: rgba(20, 20, 20, 0.85);
  --muted: rgba(0, 0, 0, 0.55);
  --muted-2: rgba(0, 0, 0, 0.38);
  --accent: #3a76d2;
  --accent-2: #5b91e5;
  --ok: #129f46;
  --bad: #d93c3c;
  --warn: #e6a600;
  --shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
  --shadow-soft: 0 8px 16px rgba(0, 0, 0, 0.05);
  --radius: 16px;
  --radius-sm: 12px;
  --radius-xs: 10px;
  --focus: 0 0 0 3px rgba(58, 117, 210, 0.2);
}

    *{ box-sizing: border-box; }
    html, body { height: 100%; }

body{
  margin:0;
  padding: 20px;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
  color: var(--text);
  background: var(--bg);
  transition: background 0.3s ease, color 0.3s ease;
}

/* –ì—Ä–∞–¥—ñ—î–Ω—Ç–∏ –¥–ª—è —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏ */

body:not([data-theme="light"]) {
  background:
    radial-gradient(1200px 600px at 12% -10%, rgba(74,144,226,0.35), transparent 60%),
    radial-gradient(900px 500px at 90% 0%, rgba(106,168,255,0.18), transparent 60%),
    radial-gradient(1000px 650px at 60% 120%, rgba(45,204,112,0.10), transparent 60%),
    linear-gradient(180deg, #070b14 0%, #0b1220 55%, #0a1020 100%);
}

[data-theme="light"] body,
body[data-theme="light"] {
  background:
    radial-gradient(1200px 600px at 12% -10%, rgba(58,117,210,0.05), transparent 60%),
    radial-gradient(900px 500px at 90% 0%, rgba(91,145,229,0.04), transparent 60%),
    radial-gradient(1000px 650px at 60% 120%, rgba(18,159,70,0.03), transparent 60%),
    linear-gradient(180deg, #f0f2f5 0%, #eaeef2 55%, #d9dee3 100%);
}
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
      padding: 14px 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
      backdrop-filter: blur(10px);
    }

    h1{
      margin:0;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 18px;
      line-height: 1.2;
    }

    .muted{ color: var(--muted); font-size: 12px; }
    .muted.small{ color: var(--muted-2); font-size: 11px; }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      font-size: 12px;
      backdrop-filter: blur(8px);
    }

    .dot{
      width: 9px; height: 9px; border-radius: 99px;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.05);
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 4px rgba(45,204,112,0.15); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(255,77,77,0.15); }

    .btn{
      cursor:pointer;
      border: 1px solid transparent;
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease, background .12s ease;
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 10px 20px rgba(74,144,226,0.18);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(0.99); }
    .btn:focus{ outline:none; box-shadow: var(--focus), 0 10px 22px rgba(74,144,226,0.18); }

    .btn.secondary{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: 0 10px 20px rgba(0,0,0,0.18);
    }
    .btn.secondary:hover{
      background: rgba(255,255,255,0.10);
      filter:none;
    }

    .tabs{
      display:flex;
      gap: 10px;
      margin: 12px 0 16px;
      flex-wrap: wrap;
    }
    .tab-btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      transition: 0.18s;
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      box-shadow: 0 8px 18px rgba(0,0,0,0.14);
      backdrop-filter: blur(8px);
    }
    .tab-btn:hover{
      background: rgba(255,255,255,0.10);
      transform: translateY(-1px);
    }
    .tab-btn.active{
      background: linear-gradient(180deg, rgba(74,144,226,0.9), rgba(74,144,226,0.55));
      border-color: rgba(74,144,226,0.55);
      box-shadow: 0 12px 24px rgba(74,144,226,0.16);
    }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .row{ display:flex; gap: 18px; align-items:flex-start; flex-wrap:wrap; }
    .col{ flex:1; min-width: 320px; }

    .box{
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
    }

    table{
      border-collapse: collapse;
      width: 100%;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
    }

    th, td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      text-align: left;
      font-size: 13px;
      color: var(--text);
    }
    th{
      background: rgba(255,255,255,0.08);
      font-weight: 900;
      color: rgba(255,255,255,0.88);
      letter-spacing: .2px;
    }
    tr:hover{ background: rgba(255,255,255,0.05); cursor:pointer; }

    label{
      display:block;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    input, textarea, select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(10,16,32,0.55);
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    input::placeholder{ color: rgba(255,255,255,0.40); }

    input:focus, textarea:focus, select:focus{
      border-color: rgba(74,144,226,0.65);
      box-shadow: var(--focus);
      background: rgba(10,16,32,0.72);
    }

    textarea{ min-height: 92px; resize: vertical; }

    select{ appearance: none; background-image:
      linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.6) 50%),
      linear-gradient(135deg, rgba(255,255,255,0.6) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 12px) calc(50% - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 34px;
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    canvas{
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
    }

    .sched-wrap{ overflow:auto; }
    #scheduleWideTable th, #scheduleWideTable td{ text-align:center; white-space:nowrap; }

    #scheduleMatrix th, #scheduleMatrix td{ text-align:center; white-space:nowrap; }
    #scheduleMatrix td.matrix-cell{
      vertical-align: top;
      min-width: 92px;
      height: 66px;
      background: rgba(255,255,255,0.03);
    }

    .daynum{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,0.95);
      margin-bottom: 4px;
      gap: 8px;
    }
    .shifttext{
      font-weight: 850;
      font-size: 12px;
      color: rgba(255,255,255,0.88);
    }
    .empty{
      background: rgba(255,255,255,0.02);
      color: rgba(255,255,255,0.35);
      cursor: default !important;
    }

    /* daily */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      font-size: 11px;
      font-weight: 900;
      margin-left: 6px;
      line-height: 1.4;
      white-space: nowrap;
    }
    .badge.open{ color: var(--warn); border-color: rgba(255,209,102,.35); }
    .badge.auto{ color: #8fd3ff; border-color: rgba(143,211,255,.35); }
    .badge.warn{ color: #ff8b8b; border-color: rgba(255,139,139,.35); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      font-size: 11px;
      font-weight: 900;
      white-space: nowrap;
    }
    .pill.warn{ color: var(--warn); border-color: rgba(255,209,102,.35); }
    .pill.viol{ color: #ff8b8b; border-color: rgba(255,139,139,.35); }

    .pill.good{ color: var(--ok); border-color: rgba(45,204,112,.35); }
    .pill.bad{ color: #ff8b8b; border-color: rgba(255,139,139,.35); }
    .pill.neutral{ color: rgba(255,255,255,0.75); border-color: rgba(255,255,255,.18); }

    tr.row-open{ background: rgba(255,209,102,.06); }
    tr.row-warn{ background: rgba(255,77,77,.06); }

    details summary{
      cursor:pointer;
      font-weight: 950;
      color: rgba(255,255,255,0.88);
      margin-top: 6px;
    }

    .modal-backdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,0.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width: 100%;
      max-width: 460px;
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .modal-header{
      padding: 14px 16px;
      background: rgba(255,255,255,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .modal-title{
      font-weight: 950;
      font-size: 14px;
      color: rgba(255,255,255,0.92);
    }
    .modal-body{ padding: 16px; }
    .modal-actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }

    .error{
      margin-top: 10px;
      background: rgba(255,77,77,0.10);
      border: 1px solid rgba(255,77,77,0.25);
      color: rgba(255,225,225,0.95);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      display:none;
      white-space: pre-wrap;
    }

    .info{
      margin-top: 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.78);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      white-space: pre-wrap;
    }

    @media (max-width: 520px){
      body{ padding: 14px; }
      .grid2{ grid-template-columns: 1fr; }
      .topbar{ padding: 12px; }
      .btn{ width: 100%; }
    }
    
    /* Plan Builder matrix */
    #pbMatrix th, #pbMatrix td { text-align:center; white-space:nowrap; }
    #pbMatrix td.pb-cell{
      position: relative;
      cursor: pointer;
      vertical-align: top;
      min-width: 98px;
      height: 74px;
      background: rgba(255,255,255,0.03);
    }
    #pbMatrix td.pb-cell:hover{ background: rgba(74,144,226,0.14); }
    #pbMatrix td.pb-cell.selected{
      outline: 2px solid rgba(74,144,226,0.65);
      box-shadow: 0 0 0 3px rgba(74,144,226,0.20);
    }
    .pb-check{
      position:absolute;
      top:8px; right:8px;
      width: 18px; height: 18px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,0.92);
    }
    .pb-cell.selected .pb-check{
      background: rgba(74,144,226,0.30);
      border-color: rgba(74,144,226,0.55);
    }
    .pb-shift{
      font-weight: 900;
      margin-top: 6px;
    }
    .pb-shift.muted0{
      color: rgba(255,255,255,0.40);
    }
    
    
   /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Å–≤—ñ—Ç–ª–æ—ó —Ç–µ–º–∏ */
/* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Å–≤—ñ—Ç–ª–æ—ó —Ç–µ–º–∏ */
[data-theme="light"] input,
[data-theme="light"] textarea,
[data-theme="light"] select {
  background: rgba(255,255,255,0.90);
  border-color: rgba(0,0,0,0.10);
  color: var(--text);
}

[data-theme="light"] input::placeholder {
  color: rgba(0,0,0,0.35);
}

[data-theme="light"] input:focus,
[data-theme="light"] textarea:focus,
[data-theme="light"] select:focus {
  background: rgba(255,255,255,1);
  border-color: rgba(59,130,246,0.40);
}

[data-theme="light"] .topbar {
  background: rgba(255,255,255,0.75);
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  backdrop-filter: blur(12px);
}

[data-theme="light"] .box {
  background: rgba(255,255,255,0.70);
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  backdrop-filter: blur(12px);
}

[data-theme="light"] .modal {
  background: rgba(255,255,255,0.95);
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  backdrop-filter: blur(12px);
}

[data-theme="light"] table {
  background: rgba(255,255,255,0.90);
  border-color: rgba(0,0,0,0.06);
}

[data-theme="light"] th {
  background: rgba(0,0,0,0.03);
  color: var(--text);
}

[data-theme="light"] td {
  border-bottom-color: rgba(0,0,0,0.05);
}

[data-theme="light"] tr:hover {
  background: rgba(59,130,246,0.04);
}

[data-theme="light"] canvas {
  background: rgba(255,255,255,0.90);
  border-color: rgba(0,0,0,0.06);
}

[data-theme="light"] .tab-btn {
  background: rgba(255,255,255,0.80);
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

[data-theme="light"] .tab-btn:hover {
  background: rgba(255,255,255,0.95);
}

[data-theme="light"] .tab-btn.active {
  background: linear-gradient(180deg, #3b82f6, #60a5fa);
  color: white;
  box-shadow: 0 4px 12px rgba(59,130,246,0.25);
}

[data-theme="light"] .btn.secondary {
  background: rgba(0,0,0,0.04);
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

[data-theme="light"] .btn.secondary:hover {
  background: rgba(0,0,0,0.06);
}

[data-theme="light"] .status-pill,
[data-theme="light"] .badge,
[data-theme="light"] .pill {
  background: rgba(255,255,255,0.85);
  border-color: rgba(0,0,0,0.08);
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}

[data-theme="light"] .pb-cell {
  background: rgba(255,255,255,0.90);
}

[data-theme="light"] .pb-cell:hover {
  background: rgba(59,130,246,0.06);
}

[data-theme="light"] .pb-cell.selected {
  outline-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
}

[data-theme="light"] .empty {
  background: rgba(0,0,0,0.02);
  color: rgba(0,0,0,0.30);
}

[data-theme="light"] .error {
  background: rgba(239,68,68,0.08);
  border-color: rgba(239,68,68,0.20);
  color: rgba(127,29,29,0.90);
}

[data-theme="light"] .info {
  background: rgba(0,0,0,0.03);
  border-color: rgba(0,0,0,0.08);
  color: rgba(0,0,0,0.70);
}

[data-theme="light"] .modal-header {
  background: rgba(255,255,255,0.50);
  border-bottom-color: rgba(0,0,0,0.06);
}

[data-theme="light"] .modal-actions {
  background: rgba(255,255,255,0.40);
  border-top-color: rgba(0,0,0,0.06);
}

[data-theme="light"] .pb-check {
  border-color: rgba(0,0,0,0.12);
  background: rgba(255,255,255,0.60);
}

[data-theme="light"] .pb-cell.selected .pb-check {
  background: rgba(59,130,246,0.20);
  border-color: rgba(59,130,246,0.40);
}
  
  </style>
</head>

<body>

<div class="topbar">
  <div>
    <h1>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h1>
    <div class="muted">–ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –≤ UTC; –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ (Europe/Warsaw).</div>
  </div>
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <button class="btn secondary" onclick="toggleTheme()" id="themeToggle" title="–ü–µ—Ä–µ–º–∏–∫–∞—á —Ç–µ–º–∏">
      <span id="themeIcon">üåô</span>
    </button>
    <div class="status-pill" title="–°—Ç–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —Ç–∞ API">
      <span id="statusDot" class="dot"></span>
      <span id="statusText">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ</span>
    </div>
    <button class="btn secondary" onclick="openLogin()">–£–≤—ñ–π—Ç–∏</button>
    <button class="btn" onclick="logout()">–í–∏–π—Ç–∏</button>
  </div>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="openTab('employees')">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</button>
  <button class="tab-btn" onclick="openTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  <button class="tab-btn" onclick="openTab('planBuilder')">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥—Ä–∞—Ñ—ñ–∫–∞</button>
  <button class="tab-btn" onclick="openTab('scheduleTab')">–ì—Ä–∞—Ñ—ñ–∫ –∑–º—ñ–Ω</button>
  <button class="tab-btn" onclick="openTab('manualEntry')">–†—É—á–Ω–∏–π –≤–≤—ñ–¥</button>
</div>

  <!-- ================= EMPLOYEES ================= -->
  <div id="employees" class="tab-content active">
    <div class="row">
      <div class="col">
        <div class="box">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div style="font-weight:950;">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</div>
            <button class="btn secondary" onclick="loadEmployees()">–û–Ω–æ–≤–∏—Ç–∏</button>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <input id="empSearch" placeholder="–ü–æ—à—É–∫: ID, –ü–Ü–ë, NFC, –ø–æ—Å–∞–¥–∞‚Ä¶" style="flex:1; min-width:240px;" oninput="applyEmployeeFilter()" />
            <button class="btn secondary" onclick="clearEmployeeSearch()">–°–∫–∏–Ω—É—Ç–∏</button>
          </div>
          <div class="muted" style="margin-top:6px;">
            –ü–æ—à—É–∫ —Ñ—ñ–ª—å—Ç—Ä—É—î —Ç–∞–±–ª–∏—Ü—é + —Å–ø–∏—Å–∫–∏ –≤–∏–±–æ—Ä—É —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞/–≥—Ä–∞—Ñ—ñ–∫ –∑–º—ñ–Ω).
          </div>
        </div>

        <table id="empTable">
          <thead>
            <tr><th>ID</th><th>–ü–Ü–ë</th><th>NFC UID</th><th>–ê–∫—Ç–∏–≤–Ω–∏–π</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="col">
        <div class="box">
          <div style="font-weight:950; margin-bottom:8px;">–°—Ç–≤–æ—Ä–∏—Ç–∏ / —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏</div>

          <input type="hidden" id="empId" />

          <label>–ü–Ü–ë</label>
          <input id="fullName" />

          <label>NFC UID</label>
          <input id="nfcUid" />

          <div class="grid2">
            <div>
              <label>–ü–æ—Å–∞–¥–∞</label>
              <select id="position"></select>
            </div>
            <div>
              <label style="margin-top: 10px;">
                <input type="checkbox" id="isActive" checked />
                –ê–∫—Ç–∏–≤–Ω–∏–π
              </label>
            </div>
          </div>

          <label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
          <textarea id="comment"></textarea>

          <label style="margin-top: 12px;">
            <input type="checkbox" id="editMode" />
            –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è–º)
          </label>
          <div class="muted" style="margin-top:6px;">
            OFF ‚Üí "–ó–±–µ—Ä–µ–≥—Ç–∏" –∑–∞–≤–∂–¥–∏ —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞.<br>
            ON ‚Üí –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –æ–±—Ä–∞–Ω–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ —Å–ø–∏—Ç–∞—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è).
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" onclick="saveEmployee()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="btn secondary" onclick="clearForm()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= STATS ================= -->
  <div id="stats" class="tab-content">
    <div class="row">
      <div class="col">
        <div class="box">
          <div style="font-weight:950;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ / –ü–ª–∞–Ω vs —Ñ–∞–∫—Ç</div>

          <label>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</label>
          <select id="empSelect"></select>

          <div class="grid2">
            <div>
              <label>–ú—ñ—Å—è—Ü—å</label>
              <input id="monthPick" type="month" />
            </div>
            <div>
              <label>–î—ñ–∞–ø–∞–∑–æ–Ω (–∞–≤—Ç–æ)</label>
              <input id="rangePreview" type="text" readonly />
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" onclick="loadStats()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
          </div>

          <div class="info" id="statsInfo">–ì–æ—Ç–æ–≤–æ.</div>
          <div class="info" id="aggInfo" style="display:none;"></div>
        </div>

        <!-- –ì—Ä–∞—Ñ—ñ–∫ Plan vs Fact -->
        <div class="box">
          <div style="font-weight:950; font-size:16px; margin-bottom:10px;">
            –ì—Ä–∞—Ñ—ñ–∫ –ü–ª–∞–Ω / –§–∞–∫—Ç
          </div>
          <div class="info" id="chartInfoStats">
            –ü—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏" –≥—Ä–∞—Ñ—ñ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±—É–¥—É—î—Ç—å—Å—è –∑–∞ –≤–∏–±—Ä–∞–Ω–∏–π –º—ñ—Å—è—Ü—å.
          </div>
          <div style="margin-top:20px;">
            <canvas id="chartCanvas" height="140"></canvas>
          </div>
        </div>

        <div class="box">
          <div style="font-weight:950; margin-bottom:8px;">–î–Ω—ñ (–ü–ª–∞–Ω / –§–∞–∫—Ç / –†—ñ–∑–Ω–∏—Ü—è)</div>
          <table id="dailyTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>–ü–ª–∞–Ω</th>
                <th>–§–∞–∫—Ç</th>
                <th>–†—ñ–∑–Ω–∏—Ü—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="muted" style="margin-top:8px;">
            üü° open = —î IN –±–µ–∑ OUT ‚Ä¢ üîí auto = –∞–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è ‚Ä¢ ‚ö† warn = –∞–Ω–æ–º–∞–ª—ñ—è ‚Ä¢ Œî = —Ñ–∞–∫—Ç ‚àí –ø–ª–∞–Ω
          </div>
        </div>
        
        
        
        
        <div class="box">
          <div style="font-weight:950; margin-bottom:8px;">–ü–æ–¥—ñ—ó (IN/OUT)</div>
          <table id="eventsTable">
            <thead>
              <tr><th>ID</th><th>Dir</th><th>Local</th><th>Terminal</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>


      </div>
    </div>
  </div>

  <!-- ================= PLAN BUILDER ================= -->
  <div id="planBuilder" class="tab-content">
    <div class="row">
      <div class="col">
        <div class="box">
          <div style="font-weight:950; margin-bottom:12px;">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥—Ä–∞—Ñ—ñ–∫–∞ (–ø–ª–∞–Ω)</div>
          
          <div class="grid2">
            <div>
              <label>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ (–ø–æ—à—É–∫)</label>
              <input id="pbSearch" placeholder="–í–≤–µ–¥–∏ –ü–Ü–ë / ID / NFC..." oninput="pbApplyFilter()" />
            </div>
            <div>
              <label>–°–ø–∏—Å–æ–∫</label>
              <select id="pbEmpSelect" onchange="pbOnEmpPicked()"></select>
            </div>
          </div>

          <div class="grid2" style="margin-top:10px;">
            <div>
              <label>–ú—ñ—Å—è—Ü—å</label>
              <input id="pbMonth" type="month" onchange="pbLoadMonth()" />
            </div>
            <div>
              <label>–®–≤–∏–¥–∫—ñ –¥—ñ—ó</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
                <button class="btn secondary" onclick="pbSelectAll()">–í–∏–±—Ä–∞—Ç–∏ –≤—Å–µ</button>
                <button class="btn secondary" onclick="pbClearSelection()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—ñ—Ä</button>
                <button class="btn secondary" onclick="pbReloadFromServer()">–ü—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞</button>
              </div>
            </div>
          </div>

          <div class="box" style="margin-top:12px; padding:12px;">
            <div class="grid2">
              <div>
                <label>–ß–∞—Å –ø–æ—á–∞—Ç–∫—É (HH:MM)</label>
                <input id="pbStart" placeholder="07:00" />
              </div>
              <div>
                <label>–ß–∞—Å –∫—ñ–Ω—Ü—è (HH:MM)</label>
                <input id="pbEnd" placeholder="19:00" />
              </div>
            </div>

            <label style="margin-top:10px;">
              <input type="checkbox" id="pbDayOff" />
              –ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ "–≤–∏—Ö—ñ–¥–Ω–∏–π" –¥–ª—è –≤–∏–±—Ä–∞–Ω–∏—Ö –¥–Ω—ñ–≤
            </label>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
              <button class="btn" onclick="pbApplyToSelected()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–±—Ä–∞–Ω–∏—Ö</button>
              <button class="btn secondary" onclick="pbClearSelectedCells()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ (–≤–∏–¥–∞–ª–∏—Ç–∏ –ø–ª–∞–Ω)</button>
              <button class="btn" onclick="pbSaveSelected()">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
            </div>

            <div class="info" id="pbInfo" style="margin-top:10px;">
              üí° –ü–æ—Ä–∞–¥–∞: –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –º—ñ—Å—è—Ü—è –ø—É—Å—Ç—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.<br>
              –í–∏–±–µ—Ä–∏ –¥–Ω—ñ ‚Üí –≤–≤–µ–¥–∏ —á–∞—Å ‚Üí "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏" ‚Üí "–ó–±–µ—Ä–µ–≥—Ç–∏".
            </div>
          </div>

          <div class="sched-wrap" style="margin-top:10px;">
            <table id="pbMatrix">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- ================= SCHEDULE (view only) ================= -->
<div id="scheduleTab" class="tab-content">
  <div class="row">
    <div class="col">
      <div class="box">
      <div style="font-weight:950;">–ì—Ä–∞—Ñ—ñ–∫ –∑–º—ñ–Ω (–ø–µ—Ä–µ–≥–ª—è–¥)</div>

        <div class="grid2">
          <div>
            <label>–†–µ–∂–∏–º</label>
            <select id="schedMode" onchange="onScheduleModeChange()">
              <option value="all">–£—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>
              <option value="single">–û–¥–∏–Ω —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ (–º–∞—Ç—Ä–∏—Ü—è)</option>
            </select>
          </div>
          <div>
            <label>–ú—ñ—Å—è—Ü—å</label>
            <input id="schedMonth" type="month" />
          </div>
        </div>

        <div id="schedSingleEmployeeBox" style="display:none;">
          <div class="grid2" style="margin-top:10px;">
            <div>
              <label>–ü–æ—à—É–∫ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</label>
              <input id="schedSearch" placeholder="–í–≤–µ–¥–∏ –ü–Ü–ë / ID / NFC..." oninput="schedApplyFilter()" />
            </div>
            <div>
              <label>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</label>
              <select id="schedEmp"></select>
            </div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn" onclick="loadSchedule()">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
          <button class="btn secondary" onclick="openSchedulePdf()">PDF</button>
        </div>

        <div class="info" style="margin-top:12px;">
          –î–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞ –ø–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥—Ä–∞—Ñ—ñ–∫–∞".
        </div>
      </div>
<div class="box" id="scheduleWideBox">
          <div style="font-weight:950; margin-bottom:8px;">–¢–∞–±–µ–ª—å (—É—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏)</div>
          <div class="sched-wrap">
            <table id="scheduleWideTable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="box" id="scheduleMatrixBox" style="display:none;">
          <div style="font-weight:950; margin-bottom:8px;">
            –ú–∞—Ç—Ä–∏—Ü—è –∑–º—ñ–Ω (7√ó4 + –∑–∞–ª–∏—à–æ–∫)
            <span class="muted" id="matrixHint" style="margin-left:8px;"></span>
          </div>
          <div class="sched-wrap">
            <table id="scheduleMatrix">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

<!-- ================= MANUAL ENTRY ================= -->
<div id="manualEntry" class="tab-content">
  <div class="row">
    <div class="col">
      <div class="box">
        <div style="font-weight:950; margin-bottom:12px;">–†—É—á–Ω–∏–π –≤–≤—ñ–¥ –ø–æ–¥—ñ—ó (–≤—Ö—ñ–¥/–≤–∏—Ö—ñ–¥)</div>
        
        <div class="info" style="margin-bottom:12px;">
          ‚ö†Ô∏è –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é —Ç—ñ–ª—å–∫–∏ —É –≤–∏–ø–∞–¥–∫—É –ø—Ä–æ–±–ª–µ–º –∑ —Ç–µ—Ä–º—ñ–Ω–∞–ª–æ–º –∞–±–æ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
          –î–ª—è –∫–æ–∂–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
        </div>

        <div class="grid2">
          <div>
            <label>–ü–æ—à—É–∫ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</label>
            <input id="manualEmpSearch" placeholder="–í–≤–µ–¥–∏ –ü–Ü–ë / ID / NFC..." oninput="manualApplyFilter()" />
          </div>
          <div>
            <label>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</label>
            <select id="manualEmpSelect"></select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>–î–∞—Ç–∞</label>
            <input id="manualDate" type="date" />
          </div>
          <div>
            <label>–ß–∞—Å –≤—Ö–æ–¥—É (–ì–ì:–•–•:–°–°)</label>
            <input id="manualTimeIn" type="time" step="1" placeholder="08:00:00" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label>–ß–∞—Å –≤–∏—Ö–æ–¥—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input id="manualTimeOut" type="time" step="1" placeholder="17:00:00" />
          </div>
          <div>
            <label style="margin-top: 26px;">
              <input type="checkbox" id="manualAddBothEvents" checked />
              –î–æ–¥–∞—Ç–∏ –æ–±–∏–¥–≤—ñ –ø–æ–¥—ñ—ó (IN —ñ OUT)
            </label>
          </div>
        </div>

        <!-- –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≥–∞–ª–æ—á–∫–∞ –ù–ï –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ -->
        <div id="manualSingleEventBox" style="margin-top:10px; display:none;">
          <label>–¢–∏–ø –ø–æ–¥—ñ—ó</label>
          <select id="manualDirection">
            <option value="IN">–í—Ö—ñ–¥ (IN)</option>
            <option value="OUT">–í–∏—Ö—ñ–¥ (OUT)</option>
          </select>
        </div>

        <div class="info" style="margin-top:10px; font-size:11px;">
          üí° <b>–†–µ–∂–∏–º "–û–±–∏–¥–≤—ñ –ø–æ–¥—ñ—ó":</b> –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç—å –≤—Ö—ñ–¥ —ñ –≤–∏—Ö—ñ–¥ –∑–∞ –≤–∫–∞–∑–∞–Ω—ñ —á–∞—Å–∏.<br>
          üí° <b>–†–µ–∂–∏–º "–û–¥–Ω–∞ –ø–æ–¥—ñ—è":</b> –°—Ç–≤–æ—Ä–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω—É –ø–æ–¥—ñ—é (–≤–∏–±—Ä–∞–Ω–æ–≥–æ —Ç–∏–ø—É).
        </div>

        <div style="margin-top:10px;">
          <label>–ö–æ–º–µ–Ω—Ç–∞—Ä / –ü—Ä–∏—á–∏–Ω–∞</label>
          <textarea id="manualComment" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –¢–µ–ª–µ—Ñ–æ–Ω —Ä–æ–∑—Ä—è–¥–∂–µ–Ω–∏–π, —Ç–µ—Ä–º—ñ–Ω–∞–ª –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤..."></textarea>
        </div>
          
          <div id="manualWarning" class="info" style="margin-top:10px; display:none; background: rgba(255,209,102,0.10); border-color: rgba(255,209,102,0.35);">
  ‚ö†Ô∏è <span id="manualWarningText"></span>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn" onclick="openManualEntryConfirm()">–î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é</button>
          <button class="btn secondary" onclick="clearManualForm()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <div id="manualInfo" class="info" style="margin-top:12px; display:none;"></div>
        <div id="manualError" class="error" style="margin-top:12px;"></div>
      </div>

      <!-- –û—Å—Ç–∞–Ω–Ω—ñ —Ä—É—á–Ω—ñ –ø–æ–¥—ñ—ó -->
      <div class="box">
        <div style="font-weight:950; margin-bottom:8px;">
          –û—Å—Ç–∞–Ω–Ω—ñ —Ä—É—á–Ω—ñ –ø–æ–¥—ñ—ó
          <button class="btn secondary" onclick="loadManualEvents()" style="margin-left:10px; padding:6px 10px; font-size:11px;">–û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
        <table id="manualEventsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</th>
              <th>–î–∞—Ç–∞/–ß–∞—Å</th>
              <th>–¢–∏–ø</th>
              <th>–ê–¥–º—ñ–Ω</th>
              <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
  <!-- ================= LOGIN ================= -->
  <div id="loginBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title">–í—Ö—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
        <button class="btn secondary" onclick="closeLogin()">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
      <div class="modal-body">
        <label>–õ–æ–≥—ñ–Ω</label>
        <input id="loginInput" autocomplete="username" />

        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="passwordInput" type="password" autocomplete="current-password" />

        <div id="loginError" class="error"></div>
        <div class="info">
          –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –∑–∞—Ö–∏—â–µ–Ω–∏—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤ (require_admin).
          –ü—ñ—Å–ª—è –≤—Ö–æ–¥—É —Ç–æ–∫–µ–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ localStorage —ñ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeLogin()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
      </div>
    </div>
  </div>

<!-- ================= MANUAL ENTRY CONFIRM ================= -->
<div id="manualConfirmBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title">‚ö†Ô∏è –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥—É</div>
      <button class="btn secondary" onclick="closeManualConfirm()">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    <div class="modal-body">
      <div class="info" style="margin-bottom:12px;">
        <strong>–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –¥–∞–Ω—ñ –ø–æ–¥—ñ—ó:</strong>
        <div id="manualConfirmDetails" style="margin-top:8px; white-space:pre-line;"></div>
      </div>

      <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
        <div style="font-weight:900; margin-bottom:8px;">–ü–æ–≤—Ç–æ—Ä–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
        
        <label>–õ–æ–≥—ñ–Ω</label>
        <input id="manualConfirmLogin" autocomplete="username" />

        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="manualConfirmPassword" type="password" autocomplete="current-password" />
      </div>

      <div id="manualConfirmError" class="error"></div>
    </div>
    <div class="modal-actions">
      <button class="btn secondary" onclick="closeManualConfirm()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn" onclick="submitManualEntry()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —ñ –¥–æ–¥–∞—Ç–∏</button>
    </div>
  </div>
</div>
<script>
  const API_ROOT = "/api";
  let chartInstance = null;

  // ===== –°–∏—Å—Ç–µ–º–∞ —Ç–µ–º =====
  function getTheme() {
    return localStorage.getItem('theme') || 'dark';
  }

  function setTheme(theme) {
    localStorage.setItem('theme', theme);
    document.documentElement.setAttribute('data-theme', theme);
    updateThemeIcon(theme);
  }

  function updateThemeIcon(theme) {
    const icon = document.getElementById('themeIcon');
    if (icon) {
      icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }
  }

  function toggleTheme() {
    const currentTheme = getTheme();
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–µ–º–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
  (function initTheme() {
    const savedTheme = getTheme();
    setTheme(savedTheme);
  })();

  // ===== positions list =====
  const POSITIONS = [
    "–ø—Ä–∏–±–∏—Ä–∞–ª—å–Ω–∏–∫ —Å–ª—É–∂–±–æ–≤–∏—Ö –ø—Ä–∏–º—ñ—â–µ–Ω—å",
    "–∫—É—Ö–∞—Ä-—É–Ω—ñ–≤–µ—Ä—Å–∞–ª",
    "–ø—Ä–æ–¥–∞–≤–µ—Ü—å-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç",
    "–ø—Ä–∏–π–º–∞–Ω—å–Ω–∏–∫ —Å–∫–ª–∞–¥—É",
    "–≤–∞–Ω—Ç–∞–∂–Ω–∏–∫",
    "–∫–µ—Ä—É—é—á–∏–π –º–∞–≥–∞–∑–∏–Ω–æ–º",
    "–∑–∞—Å—Ç—É–ø–Ω–∏–∫ –∫–µ—Ä—É—é—á–æ–≥–æ",
  ];

  function setStatus(ok, text) {
    const dot = document.getElementById("statusDot");
    const t = document.getElementById("statusText");
    dot.classList.remove("ok", "bad");
    if (ok === true) dot.classList.add("ok");
    if (ok === false) dot.classList.add("bad");
    t.textContent = text;
  }

  function getToken() { return localStorage.getItem("admin_token") || ""; }
  function setToken(token) { localStorage.setItem("admin_token", token); }
  function clearToken() { localStorage.removeItem("admin_token"); }

  function openLogin() {
    document.getElementById("loginError").style.display = "none";
    document.getElementById("loginError").textContent = "";
    document.getElementById("loginBackdrop").classList.add("show");
    setTimeout(() => document.getElementById("loginInput").focus(), 0);
  }
  function closeLogin() { document.getElementById("loginBackdrop").classList.remove("show"); }

  function logout() {
    clearToken();
    setStatus(false, "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
    openLogin();
  }

  function extractToken(payload) {
    if (!payload) return "";
    if (typeof payload === "string") return payload.trim();
    if (payload.access_token) return String(payload.access_token).trim();
    if (payload.token) return String(payload.token).trim();
    if (payload.data && payload.data.access_token) return String(payload.data.access_token).trim();
    if (payload.data && payload.data.token) return String(payload.data.token).trim();
    return "";
  }

  async function login() {
    const loginVal = document.getElementById("loginInput").value.trim();
    const passVal  = document.getElementById("passwordInput").value;

    const errBox = document.getElementById("loginError");
    errBox.style.display = "none";
    errBox.textContent = "";

    if (!loginVal || !passVal) {
      errBox.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ª–æ–≥—ñ–Ω —ñ –ø–∞—Ä–æ–ª—å.";
      errBox.style.display = "block";
      return;
    }

    try {
      const res = await fetch(`${API_ROOT}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: loginVal, password: passVal })
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`Login HTTP ${res.status}\n${txt}`);
      }

      const payload = await res.json().catch(async () => await res.text());
      const token = extractToken(payload);
      if (!token) throw new Error("–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π, –∞–ª–µ —Ç–æ–∫–µ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ /api/login.");

      setToken(token);
      closeLogin();
      setStatus(true, "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
      await loadEmployees();
    } catch (e) {
      errBox.textContent = String(e?.message || e);
      errBox.style.display = "block";
      setStatus(false, "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É");
    }
  }

  async function apiFetch(path, opts = {}) {
    const token = getToken();
    const headers = new Headers(opts.headers || {});
    if (token) headers.set("Authorization", `Bearer ${token}`);

    const res = await fetch(`${API_ROOT}${path}`, { ...opts, headers });

    if (res.status === 401) {
      setStatus(false, "401: –ø–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥");
      openLogin();
    }
    return res;
  }

    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    
      document.querySelectorAll('.tab-btn').forEach(b => {
        const onclick = b.getAttribute("onclick") || "";
        if (onclick.includes(`'${tabId}'`)) b.classList.add("active");
      });
    
      if (tabId === 'planBuilder') {
        pbInit();
      }
      
      if (tabId === 'scheduleTab') {
        schedInitFilters();
      }
      if (tabId === 'manualEntry') {
          manualInitFilters();
      }
    }

  function fmtJsonError(text) {
    if (!text) return "";
    if (text.length > 1200) return text.slice(0, 1200) + "\n...trimmed...";
    return text;
  }
  
function fmtTime(ts) {
  if (!ts) return "";
  const s = String(ts).trim();
  
  const d = new Date(s);
  if (!Number.isNaN(d.getTime())) {
    // –ü–æ–∫–∞–∑—É—î–º–æ –î–ê–¢–£ –Ü –ß–ê–°
    return d.toLocaleString('uk-UA', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
  }
  
  const m = s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if (m) return `${m[1]}:${m[2]}:${m[3] ?? "00"}`;
  
  return "";
}

  function toLocalMinutesAny(value) {
    if (!value) return null;
  
    const s = String(value).trim();
  
    const m = s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
    if (m) {
      const hh = Number(m[1]), mm = Number(m[2]);
      if (hh > 23 || mm > 59) return null;
      return hh * 60 + mm;
    }
  
    const d = new Date(s);
    if (Number.isNaN(d.getTime())) return null;
    return d.getHours() * 60 + d.getMinutes();
  }
  
    function hhmmToMinutes(hhmm) {
      const s = String(hhmm || "").trim();
      // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ HH:MM —Ç–∞ HH:MM:SS
      const m = s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (!m) return null;
      const hh = Number(m[1]), mm = Number(m[2]);
      if (hh > 23 || mm > 59) return null;
      return hh * 60 + mm;
    }
  
  function clamp0(n){ return Math.max(0, n); }
  
  function alignActualToShift(actualMin, expectedStartMin) {
    if (actualMin === null || expectedStartMin === null) return actualMin;
    if (actualMin < expectedStartMin) return actualMin + 24 * 60;
    return actualMin;
  }

  function escapeHtml(s) {
    return String(s)
      .split("&").join("&amp;")
      .split("<").join("&lt;")
      .split(">").join("&gt;")
      .split('"').join("&quot;")
      .split("'").join("&#039;");
  }

  // ===== Month helpers =====
  function ymd(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function daysInMonth(year, month1based) {
    return new Date(year, month1based, 0).getDate();
  }
  function monthToRange(monthStr) {
    const [y, m] = String(monthStr || "").split("-").map(Number);
    if (!y || !m) return null;
    const from = `${y}-${String(m).padStart(2,"0")}-01`;
    const to = `${y}-${String(m).padStart(2,"0")}-${String(daysInMonth(y, m)).padStart(2,"0")}`;
    return { from, to };
  }
  function parseHHMM(s) {
    const m = String(s || "").match(/^(\d{2}):(\d{2})$/);
    if (!m) return null;
    const hh = Number(m[1]), mm = Number(m[2]);
    if (hh > 23 || mm > 59) return null;
    return hh * 60 + mm;
  }
  function minutesToSignedLabel(mins) {
    if (mins === null || mins === undefined) return "";
    const sign = mins > 0 ? "+" : (mins < 0 ? "‚àí" : "");
    const a = Math.abs(mins);
    const hh = Math.floor(a / 60);
    const mm = a % 60;
    if (hh === 0) return `${sign}${mm} —Ö–≤`;
    return `${sign}${hh}–≥ ${String(mm).padStart(2,"0")}—Ö–≤`;
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function minutesToHHMM(totalMin) {
    if (totalMin === null || totalMin === undefined) return "";
    totalMin = ((totalMin % (24*60)) + (24*60)) % (24*60);
    const hh = Math.floor(totalMin / 60);
    const mm = totalMin % 60;
    return `${pad2(hh)}:${pad2(mm)}`;
  }

  function toLocalMinutesFromTs(ts) {
    if (!ts) return null;
    const d = new Date(ts);
    if (Number.isNaN(d.getTime())) return null;
    return d.getHours() * 60 + d.getMinutes();
  }

  async function safeJson(res) {
    const txt = await res.text().catch(() => "");
    try { return JSON.parse(txt); } catch { return txt || null; }
  }

  function makeEmptyDaily(from, to) {
    const items = [];
    const days = eachDay(from, to);
    for (const d of days) {
      const day = ymd(d);
      items.push({
        date_local: day,
        worked_minutes: 0,
        worked_hms: "00:00:00",
        first_in_local: null,
        last_out_local: null,
        open_shift: false,
        auto_closed: false,
        anomalies: []
      });
    }
    return { items, total_minutes: 0, total_hms: "00:00:00", weeks: [], months: [] };
  }

  
  // ====== Employee search/filter/cache ======
  let _employeesCache = [];

  function clearEmployeeSearch() {
    const inp = document.getElementById("empSearch");
    if (inp) inp.value = "";
    applyEmployeeFilter();
  }

  function applyEmployeeFilter() {
    const inp = document.getElementById("empSearch");
    const q = (inp?.value || "").trim().toLowerCase();

    const filtered = !q ? _employeesCache : _employeesCache.filter(e => {
      const hay = [e.id, e.full_name, e.nfc_uid, e.position, e.comment].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });

    renderEmployeesTableAndSelects(filtered);
  }

  function initPositionSelect() {
    const sel = document.getElementById("position");
    sel.innerHTML = `<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –ø–æ—Å–∞–¥—É ‚Äî</option>` +
      POSITIONS.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  function renderEmployeesTableAndSelects(list) {
    const tbody = document.querySelector("#empTable tbody");
    tbody.innerHTML = "";
    list.forEach(emp => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${emp.id}</td><td>${emp.full_name}</td><td>${emp.nfc_uid}</td><td>${emp.is_active}</td>`;
      tr.onclick = () => loadEmployee(emp.id);
      tbody.appendChild(tr);
    });

    const sel = document.getElementById("empSelect");
    sel.innerHTML = "";
    list.forEach(emp => {
      const opt = document.createElement("option");
      opt.value = emp.id;
      opt.textContent = `${emp.id} ‚Äî ${emp.full_name}`;
      sel.appendChild(opt);
    });

    const schedEmp = document.getElementById("schedEmp");
    const keep = schedEmp.value;
    schedEmp.innerHTML = `<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å ‚Äî</option>`;
    list.forEach(emp => {
      const opt = document.createElement("option");
      opt.value = emp.id;
      opt.textContent = `${emp.id} ‚Äî ${emp.full_name}`;
      schedEmp.appendChild(opt);
    });
    if (keep) schedEmp.value = keep;
  }

  async function loadEmployees() {
    const res = await apiFetch(`/employees/`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`employees HTTP ${res.status}\n${fmtJsonError(txt)}`);
    }
    const data = await res.json();
    _employeesCache = data;
    applyEmployeeFilter();
    setStatus(!!getToken(), getToken() ? "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ" : "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
  }

  async function loadEmployee(id) {
    const res = await apiFetch(`/employees/${id}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
    }
    const emp = await res.json();
    empId.value = emp.id;
    fullName.value = emp.full_name;
    nfcUid.value = emp.nfc_uid;
    position.value = emp.position || "";
    comment.value = emp.comment || "";
    isActive.checked = !!emp.is_active;
  }

  function isEditModeOn() {
    return !!document.getElementById("editMode")?.checked;
  }

  async function saveEmployee() {
    const id = (empId.value || "").trim();

    const payload = {
      full_name: (fullName.value || "").trim() || undefined,
      nfc_uid: (nfcUid.value || "").trim() || undefined,
      position: (position.value || "").trim() || undefined,
      comment: (comment.value || "").trim() || undefined,
      is_active: isActive.checked
    };

    if (!payload.full_name || !payload.nfc_uid) {
      alert("–ü–Ü–ë —Ç–∞ NFC UID –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ.");
      return;
    }

    if (!isEditModeOn()) {
      if (!confirm(`–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞?\n\n–ü–Ü–ë: ${payload.full_name}\nNFC: ${payload.nfc_uid}\n–ü–æ—Å–∞–¥–∞: ${payload.position || "-"}`)) return;

      const res = await apiFetch(`/employees/`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`create employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }

      clearForm(true);
      await loadEmployees();
      return;
    }

    if (id) {
      if (!confirm(`–¢–æ—á–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ #${id}?\n\n–ü–Ü–ë: ${payload.full_name}\nNFC: ${payload.nfc_uid}\n–ü–æ—Å–∞–¥–∞: ${payload.position || "-"}`)) return;

      const res = await apiFetch(`/employees/${id}`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`update employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }

      await loadEmployees();
      return;
    } else {
      if (!confirm(`–°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞?\n\n–ü–Ü–ë: ${payload.full_name}\nNFC: ${payload.nfc_uid}\n–ü–æ—Å–∞–¥–∞: ${payload.position || "-"}`)) return;

      const res = await apiFetch(`/employees/`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`create employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }

      clearForm(true);
      await loadEmployees();
    }
  }

  function clearForm(force = false) {
    const hasData =
      (fullName.value || "").trim() ||
      (nfcUid.value || "").trim() ||
      (position.value || "").trim() ||
      (comment.value || "").trim() ||
      (empId.value || "").trim();

    if (!force && hasData) {
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É? –ù–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.")) return;
    }

    empId.value = "";
    fullName.value = "";
    nfcUid.value = "";
    position.value = "";
    comment.value = "";
    isActive.checked = true;
  }

  // ===== Schedule helpers =====

function scheduleCellText(it) {
  if (!it) return "";
  if (it.code) return it.code;
  
  // –Ø–∫—â–æ –æ–±–∏–¥–≤–∞ —á–∞—Å–∏ 00:00 - –ø–æ–∫–∞–∑—É—î–º–æ –ø—Ä–æ—á–µ—Ä–∫
  if (it.start_hhmm === "00:00" && it.end_hhmm === "00:00") return "‚Äî";
  
  if (it.start_hhmm || it.end_hhmm) return `${it.start_hhmm || ""}-${it.end_hhmm || ""}`;
  return "";
}

  function calcExpectedMinutesFromScheduleItem(it) {
    if (!it || it.code) return null;
    const a = parseHHMM(it.start_hhmm);
    const b = parseHHMM(it.end_hhmm);
    if (a === null || b === null) return null;

    let diff = b - a;
    if (diff < 0) diff += 24 * 60;
    return diff;
  }

  function buildScheduleMap(schedulePayload) {
    const map = new Map();
    const items = (schedulePayload && schedulePayload.items) ? schedulePayload.items : [];
    for (const it of items) {
      const day = it.day;
      map.set(day, {
        text: scheduleCellText(it),
        start_hhmm: it.start_hhmm || null,
        end_hhmm: it.end_hhmm || null,
        code: it.code || null,
        expected_minutes: calcExpectedMinutesFromScheduleItem(it)
      });
    }
    return map;
  }

  function renderEvents(events) {
    const tbody = document.querySelector("#eventsTable tbody");
    tbody.innerHTML = "";
    (events || []).forEach(e => {
      const tr = document.createElement("tr");
      const ts = e.ts_local || e.tsLocal || e.ts_utc || e.tsUtc || e.ts;
      tr.innerHTML = `
        <td>${e.id ?? ""}</td>
        <td>${String(e.direction || "").toUpperCase()}</td>
        <td>${fmtTime(ts)}</td>
        <td>${e.terminal_id ?? ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderAggregates(dailyPayload) {
    const box = document.getElementById("aggInfo");
    if (!box) return;

    if (!dailyPayload) {
      box.style.display = "none";
      box.textContent = "";
      return;
    }

    const totalMin = dailyPayload.total_minutes ?? 0;
    const totalHms = dailyPayload.total_hms ?? "";
    const weeks = dailyPayload.weeks || [];
    const months = dailyPayload.months || [];

    const weeksHtml = weeks.length
      ? weeks.map(w => `<div>‚Ä¢ ${w.week_start_local} ‚Üí ${w.week_end_local}: <b>${w.worked_hms}</b> (${w.worked_minutes} —Ö–≤)</div>`).join("")
      : "<div>‚Äî</div>";

    const monthsHtml = months.length
      ? months.map(m => `<div>‚Ä¢ ${m.month}: <b>${m.worked_hms}</b> (${m.worked_minutes} —Ö–≤)</div>`).join("")
      : "<div>‚Äî</div>";

    box.style.display = "block";
    box.innerHTML = `
      <div><b>–ü—ñ–¥—Å—É–º–æ–∫ –º—ñ—Å—è—Ü—è:</b> ${totalHms} (${totalMin} —Ö–≤)</div>
      <details style="margin-top:6px;">
        <summary>–ú—ñ—Å—è—Ü—ñ</summary>
        ${monthsHtml}
      </details>
    `;
  }

  function minutesLabel(min) {
    if (min === null || min === undefined) return "‚Äî";
    if (min === 0) return "‚Äî";
    const sign = min > 0 ? "+" : "‚àí";
    const a = Math.abs(min);
    const hh = Math.floor(a / 60);
    const mm = a % 60;
    if (hh === 0) return `${sign}${mm} —Ö–≤`;
    return `${sign}${hh}–≥ ${String(mm).padStart(2,"0")}—Ö–≤`;
  }

  function pillNeutral(text="‚Äî") { return `<span class="pill neutral">${escapeHtml(text)}</span>`; }
  function pillWarn(text) { return `<span class="pill warn">${escapeHtml(text)}</span>`; }
  function pillViol(text="–ü–æ—Ä—É—à–µ–Ω–Ω—è") { return `<span class="pill viol">${escapeHtml(text)}</span>`; }
  function pillGood(text) { return `<span class="pill good">${escapeHtml(text)}</span>`; }
  function pillBad(text) { return `<span class="pill bad">${escapeHtml(text)}</span>`; }

  function renderDailyPlanFact(dailyItems, scheduleMap) {
    const tbody = document.querySelector("#dailyTable tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    (dailyItems || []).forEach(r => {
      const day = r.date_local || "";
      const sch = (scheduleMap && scheduleMap.get) ? (scheduleMap.get(day) || null) : null;

      const open = !!r.open_shift;
      const autoClosed = !!r.auto_closed;
      const hasWarn = Array.isArray(r.anomalies) && r.anomalies.length > 0;

      const planText = (sch && sch.text) ? sch.text : "";
      const planMinutes = (sch && sch.expected_minutes !== undefined && sch.expected_minutes !== null)
        ? sch.expected_minutes
        : null;

      const planHtml = planText
        ? `<b>${escapeHtml(planText)}</b>${planMinutes !== null ? ` <span class="muted small">(${planMinutes} —Ö–≤)</span>` : ""}`
        : `<span class="muted small">‚Äî</span>`;

      const factWorked = (r.worked_minutes !== undefined && r.worked_minutes !== null) ? r.worked_minutes : null;

      const inVal = r.first_in_local || null;
        const today = ymd(new Date());
        const isToday = (day === today);
        const shouldShowOut = !open || !isToday;
        const outVal = shouldShowOut ? (r.last_out_local || null) : null;

      const inLabel = inVal ? fmtTime(inVal) : "";
      const outLabel = outVal ? fmtTime(outVal) : "";

      let factHtml = `<span class="muted small">‚Äî</span>`;
      if (inLabel || outLabel || factWorked !== null) {
        const parts = [];
        if (inLabel || outLabel) parts.push(`${inLabel}${outLabel ? " ‚Üí " + outLabel : ""}`);
        if (r.worked_hms) parts.push(`<span class="muted small">${escapeHtml(r.worked_hms)}</span>`);
        factHtml = parts.join(" <span class='muted small'>|</span> ");
      }

      const badges = []
        .concat(open ? [`<span class="badge open">open</span>`] : [])
        .concat(autoClosed ? [`<span class="badge auto">auto</span>`] : [])
        .concat(hasWarn ? [`<span class="badge warn">warn</span>`] : [])
        .join("");

      let deltaHtml = `<span class="pill neutral">‚Äî</span>`;

      if (!open && planMinutes !== null && factWorked !== null) {
        const delta = factWorked - planMinutes;
        if (delta > 0) deltaHtml = `<span class="pill good">+${delta} —Ö–≤</span>`;
        else if (delta < 0) deltaHtml = `<span class="pill bad">${delta} —Ö–≤</span>`;
        else deltaHtml = `<span class="pill neutral">‚Äî</span>`;
      } else if (planMinutes === null && factWorked !== null && factWorked > 0) {
        deltaHtml = `<span class="pill good">+${factWorked} —Ö–≤</span>`;
      }

      const tr = document.createElement("tr");
      if (open) tr.classList.add("row-open");
      if (hasWarn) tr.classList.add("row-warn");

      tr.innerHTML = `
        <td>${escapeHtml(day)}</td>
        <td>${planHtml}</td>
        <td>${factHtml} ${badges}</td>
        <td>${deltaHtml}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function dateLocalFromTsAny(ts) {
    if (!ts) return null;
    const s = String(ts).trim();

    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    const d = new Date(s);
    if (Number.isNaN(d.getTime())) return null;
    return ymd(d);
  }

  function mergeDailyWithIntervals(dailyItems, intervals, events) {
    const out = Array.isArray(dailyItems) ? [...dailyItems] : [];
    const byDay = new Map(out.map(x => [x.date_local, x]));

    if (Array.isArray(intervals) && intervals.length) {
      const sumByDay = new Map();

      for (const it of intervals) {
        const a = it.start_local || it.start || it.ts_start_local || it.ts_start || it.in_ts || it.in || null;
        const b = it.end_local   || it.end   || it.ts_end_local   || it.ts_end || it.out_ts || it.out || null;

        const day = dateLocalFromTsAny(a) || dateLocalFromTsAny(b);
        if (!day) continue;

        const da = new Date(a);
        const db = new Date(b);
        if (Number.isNaN(da.getTime()) || Number.isNaN(db.getTime())) continue;

        const mins = Math.max(0, Math.round((db - da) / 60000));
        sumByDay.set(day, (sumByDay.get(day) || 0) + mins);
      }

      for (const [day, mins] of sumByDay.entries()) {
        if (!byDay.has(day)) {
          const obj = {
            date_local: day,
            worked_minutes: mins,
            worked_hms: `${Math.floor(mins/60)}:${String(mins%60).padStart(2,"0")}:00`,
            first_in_local: null,
            last_out_local: null,
            open_shift: false,
            auto_closed: false,
            anomalies: ["added_from_intervals"]
          };
          byDay.set(day, obj);
          out.push(obj);
        } else {
          const cur = byDay.get(day);
          if ((cur.worked_minutes ?? null) === null || cur.worked_minutes === 0) {
            cur.worked_minutes = mins;
            cur.worked_hms = cur.worked_hms || `${Math.floor(mins/60)}:${String(mins%60).padStart(2,"0")}:00`;
          }
        }
      }
}

    if (Array.isArray(events) && events.length) {
      for (const e of events) {
        const ts = e.ts_local || e.tsLocal || e.ts_utc || e.tsUtc || e.ts;
        const day = dateLocalFromTsAny(ts);
        if (!day) continue;

        if (!byDay.has(day)) {
          const obj = {
            date_local: day,
            worked_minutes: null,
            worked_hms: "",
            first_in_local: null,
            last_out_local: null,
            open_shift: false,
            auto_closed: false,
            anomalies: ["has_scans_no_daily"]
          };
          byDay.set(day, obj);
          out.push(obj);
        }
      }
    }

    out.sort((a,b) => String(a.date_local).localeCompare(String(b.date_local)));
    return out;
  }

  function parseYmd(s) {
    const parts = String(s || "").split("-").map(Number);
    if (parts.length !== 3 || parts.some(n => !Number.isFinite(n))) return new Date();
    const [y, m, d] = parts;
    return new Date(y, m - 1, d);
  }

  function eachDay(fromStr, toStr) {
    const out = [];
    let cur = parseYmd(fromStr);
    const end = parseYmd(toStr);
    while (cur <= end) {
      out.push(new Date(cur));
      cur.setDate(cur.getDate() + 1);
    }
    return out;
  }

  function mergeDailyWithAllDays(from, to, dailyItems) {
    const byDay = new Map((dailyItems || []).map(x => [x.date_local, x]));
    const out = [];
    for (const d of eachDay(from, to)) {
      const day = ymd(d);
      const existing = byDay.get(day);
      out.push(existing || {
        date_local: day,
        worked_minutes: 0,
        worked_hms: "00:00:00",
        first_in_local: null,
        last_out_local: null,
        open_shift: false,
        auto_closed: false,
        anomalies: []
      });
    }
    return out;
  }

// ===== MANUAL ENTRY - UPDATED =====

// –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–æ–ª–µ –≤–∏–±–æ—Ä—É —Ç–∏–ø—É –ø–æ–¥—ñ—ó
function toggleManualEventType() {
  const addBoth = document.getElementById("manualAddBothEvents").checked;
  const singleBox = document.getElementById("manualSingleEventBox");
  if (singleBox) {
    singleBox.style.display = addBoth ? "none" : "block";
  }
}

// –î–æ–¥–∞—Ç–∏ —Å–ª—É—Ö–∞—á –Ω–∞ –≥–∞–ª–æ—á–∫—É
document.addEventListener("DOMContentLoaded", () => {
  const checkbox = document.getElementById("manualAddBothEvents");
  if (checkbox) {
    checkbox.addEventListener("change", toggleManualEventType);
    toggleManualEventType(); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
  }
});

let manualEmployeesFiltered = [];
let manualPendingData = null;

function manualApplyFilter() {
  const q = (document.getElementById("manualEmpSearch")?.value || "").trim().toLowerCase();
  manualEmployeesFiltered = !q ? [..._employeesCache] : _employeesCache.filter(e => {
    const hay = [e.id, e.full_name, e.nfc_uid, e.position, e.comment].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  });
  manualRenderEmpSelect();
}

function manualRenderEmpSelect() {
  const sel = document.getElementById("manualEmpSelect");
  if (!sel) return;
  
  const keep = sel.value;
  sel.innerHTML = `<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ ‚Äî</option>`;
  
  (manualEmployeesFiltered || []).forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.id;
    opt.textContent = `${e.id} ‚Äî ${e.full_name} (${e.nfc_uid})`;
    sel.appendChild(opt);
  });
  
  if (keep) sel.value = keep;
}

async function manualInitFilters() {
  manualEmployeesFiltered = Array.isArray(_employeesCache) ? [..._employeesCache] : [];
  manualRenderEmpSelect();
  
  // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É —ñ —á–∞—Å
  const now = new Date();
  const dateEl = document.getElementById("manualDate");
  const timeInEl = document.getElementById("manualTimeIn");
  const timeOutEl = document.getElementById("manualTimeOut");
  
  if (dateEl) {
    dateEl.value = ymd(now);
  }
  
  if (timeInEl) {
    timeInEl.value = "08:00:00";
  }
  
  if (timeOutEl) {
    timeOutEl.value = "17:00:00";
  }
  
  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ –ø–æ–ª—ñ–≤
  toggleManualEventType();
  
  // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó
  await loadManualEvents();
}

function clearManualForm() {
  document.getElementById("manualEmpSelect").value = "";
  document.getElementById("manualEmpSearch").value = "";
  document.getElementById("manualComment").value = "";
  
  const now = new Date();
  document.getElementById("manualDate").value = ymd(now);
  
  document.getElementById("manualTimeIn").value = "07:00:00";
  document.getElementById("manualTimeOut").value = "15:00:00";
  document.getElementById("manualAddBothEvents").checked = true;
  document.getElementById("manualDirection").value = "IN";
  
  toggleManualEventType();
  
  const infoEl = document.getElementById("manualInfo");
  const errorEl = document.getElementById("manualError");
  if (infoEl) infoEl.style.display = "none";
  if (errorEl) errorEl.style.display = "none";
}

function openManualEntryConfirm() {
  const empId = document.getElementById("manualEmpSelect").value;
  const dateVal = document.getElementById("manualDate").value;
  const timeInVal = document.getElementById("manualTimeIn").value;
  const timeOutVal = document.getElementById("manualTimeOut").value;
  const addBoth = document.getElementById("manualAddBothEvents").checked;
  const direction = document.getElementById("manualDirection").value;
  const comment = document.getElementById("manualComment").value.trim();
  
  const errorEl = document.getElementById("manualError");
  errorEl.style.display = "none";
  
  if (!empId) {
    errorEl.textContent = "–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞";
    errorEl.style.display = "block";
    return;
  }
  
  if (!dateVal) {
    errorEl.textContent = "–í–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É";
    errorEl.style.display = "block";
    return;
  }
  
  if (!timeInVal) {
    errorEl.textContent = "–í–∫–∞–∂—ñ—Ç—å —á–∞—Å –≤—Ö–æ–¥—É";
    errorEl.style.display = "block";
    return;
  }
  
  if (!comment) {
    errorEl.textContent = "–í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥—É";
    errorEl.style.display = "block";
    return;
  }
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ –≥–∞–ª–æ—á–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, —á–∞—Å –≤–∏—Ö–æ–¥—É –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π
  if (addBoth && !timeOutVal) {
    errorEl.textContent = "–í–∫–∞–∂—ñ—Ç—å —á–∞—Å –≤–∏—Ö–æ–¥—É –∞–±–æ –∑–Ω—ñ–º—ñ—Ç—å –≥–∞–ª–æ—á–∫—É";
    errorEl.style.display = "block";
    return;
  }
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∞—Å –≤–∏—Ö–æ–¥—É –º–∞—î –±—É—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ —á–∞—Å—É –≤—Ö–æ–¥—É
  if (addBoth && timeOutVal) {
    const timeIn = hhmmToMinutes(timeInVal);
    const timeOut = hhmmToMinutes(timeOutVal);
    
    if (timeOut <= timeIn) {
      errorEl.textContent = "–ß–∞—Å –≤–∏—Ö–æ–¥—É –º–∞—î –±—É—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ —á–∞—Å—É –≤—Ö–æ–¥—É";
      errorEl.style.display = "block";
      return;
    }
  }
  
  // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞
  const employee = _employeesCache.find(e => e.id == empId);
  if (!employee) {
    errorEl.textContent = "–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
    errorEl.style.display = "block";
    return;
  }
  
  // –§–æ—Ä–º—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
  manualPendingData = {
    employee_id: parseInt(empId),
    date: dateVal,
    time_in: timeInVal,
    time_out: addBoth ? timeOutVal : null,
    direction: addBoth ? null : direction, // –¢–∏–ø –ø–æ–¥—ñ—ó —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –æ–¥–Ω–∞ –ø–æ–¥—ñ—è
    comment: comment,
  };
  
  // –ü–æ–∫–∞–∑—É—î–º–æ –¥–µ—Ç–∞–ª—ñ –≤ –º–æ–¥–∞–ª—Ü—ñ
  const detailsEl = document.getElementById("manualConfirmDetails");
  let detailsText = `–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫: ${employee.full_name} (${employee.nfc_uid})\n` +
    `–î–∞—Ç–∞: ${dateVal}\n`;
  
  if (addBoth) {
    detailsText += `–ß–∞—Å –≤—Ö–æ–¥—É: ${timeInVal}\n`;
    detailsText += `–ß–∞—Å –≤–∏—Ö–æ–¥—É: ${timeOutVal}\n`;
    
    // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ
    const timeIn = hhmmToMinutes(timeInVal);
    const timeOut = hhmmToMinutes(timeOutVal);
    const duration = timeOut - timeIn;
    const hours = Math.floor(duration / 60);
    const mins = duration % 60;
    detailsText += `–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: ${hours}–≥ ${mins}—Ö–≤\n`;
  } else {
    detailsText += `–¢–∏–ø –ø–æ–¥—ñ—ó: ${direction === 'IN' ? '–í–•–Ü–î' : '–í–ò–•–Ü–î'}\n`;
    detailsText += `–ß–∞—Å: ${timeInVal}\n`;
  }
  
  detailsText += `–ö–æ–º–µ–Ω—Ç–∞—Ä: ${comment}`;
  
  detailsEl.textContent = detailsText;
  
  // –û—á–∏—â—É—î–º–æ –ø–æ–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  document.getElementById("manualConfirmLogin").value = "";
  document.getElementById("manualConfirmPassword").value = "";
  document.getElementById("manualConfirmError").style.display = "none";
  
  // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª–∫—É
  document.getElementById("manualConfirmBackdrop").classList.add("show");
  setTimeout(() => document.getElementById("manualConfirmLogin").focus(), 100);
}

function closeManualConfirm() {
  document.getElementById("manualConfirmBackdrop").classList.remove("show");
  manualPendingData = null;
}

async function submitManualEntry() {
  const login = document.getElementById("manualConfirmLogin").value.trim();
  const password = document.getElementById("manualConfirmPassword").value;
  const errorEl = document.getElementById("manualConfirmError");
  
  errorEl.style.display = "none";
  
  if (!login || !password) {
    errorEl.textContent = "–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —ñ –ø–∞—Ä–æ–ª—å";
    errorEl.style.display = "block";
    return;
  }
  
  if (!manualPendingData) {
    errorEl.textContent = "–ü–æ–º–∏–ª–∫–∞: –¥–∞–Ω—ñ –ø–æ–¥—ñ—ó –≤—ñ–¥—Å—É—Ç–Ω—ñ";
    errorEl.style.display = "block";
    return;
  }
  
  try {
    // 1. –ü–æ–≤—Ç–æ—Ä–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
    const authRes = await fetch(`${API_ROOT}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: login, password: password })
    });
    
    if (!authRes.ok) {
      throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å");
    }
    
    const authData = await authRes.json();
    const tempToken = extractToken(authData);
    
    if (!tempToken) {
      throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó");
    }
    
    // 2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –ø–æ–¥—ñ—ó –Ω–∞ —Ü—é –¥–∞—Ç—É
    const checkRes = await fetch(
      `${API_ROOT}/events/manual/date/${manualPendingData.employee_id}/${manualPendingData.date}`,
      {
        headers: { "Authorization": `Bearer ${tempToken}` }
      }
    );
    
    let existingEvents = [];
    if (checkRes.ok) {
      const checkData = await checkRes.json();
      existingEvents = checkData.events || [];
    }
    
    // 3. –í–∏–∑–Ω–∞—á–∏—Ç–∏ —è–∫—ñ –ø–æ–¥—ñ—ó —Ç—Ä–µ–±–∞ –≤–∏–¥–∞–ª–∏—Ç–∏
    const eventsToDelete = [];
    
    if (manualPendingData.time_out) {
      // –†–µ–∂–∏–º "–û–±–∏–¥–≤—ñ –ø–æ–¥—ñ—ó" - –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —ñ—Å–Ω—É—é—á—ñ IN —ñ OUT
      existingEvents.forEach(e => {
        if (e.direction === "IN" || e.direction === "OUT") {
          eventsToDelete.push(e.id);
        }
      });
    } else {
      // –†–µ–∂–∏–º "–û–¥–Ω–∞ –ø–æ–¥—ñ—è" - –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Ç–æ–≥–æ –∂ —Ç–∏–ø—É
      const targetDirection = manualPendingData.direction;
      existingEvents.forEach(e => {
        if (e.direction === targetDirection) {
          eventsToDelete.push(e.id);
        }
      });
    }
    
    // 4. –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –ø–æ–¥—ñ—ó
    for (const eventId of eventsToDelete) {
      const delRes = await fetch(`${API_ROOT}/events/manual/${eventId}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${tempToken}` }
      });
      
      if (!delRes.ok) {
        console.warn(`–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–¥—ñ—é ${eventId}`);
      }
    }
    
    // 5. –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—ñ –ø–æ–¥—ñ—ó
    const eventsToCreate = [];
    
    if (manualPendingData.time_out) {
      // –†–µ–∂–∏–º "–û–±–∏–¥–≤—ñ –ø–æ–¥—ñ—ó"
      eventsToCreate.push({
        employee_id: manualPendingData.employee_id,
        timestamp: `${manualPendingData.date}T${manualPendingData.time_in}`,
        direction: "IN",
        terminal_id: null,
        comment: manualPendingData.comment
      });
      
      eventsToCreate.push({
        employee_id: manualPendingData.employee_id,
        timestamp: `${manualPendingData.date}T${manualPendingData.time_out}`,
        direction: "OUT",
        terminal_id: null,
        comment: manualPendingData.comment
      });
    } else {
      // –†–µ–∂–∏–º "–û–¥–Ω–∞ –ø–æ–¥—ñ—è"
      eventsToCreate.push({
        employee_id: manualPendingData.employee_id,
        timestamp: `${manualPendingData.date}T${manualPendingData.time_in}`,
        direction: manualPendingData.direction,
        terminal_id: null,
        comment: manualPendingData.comment
      });
    }
    
    // 6. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–æ–≤—ñ –ø–æ–¥—ñ—ó
    const results = [];
    for (const eventData of eventsToCreate) {
      const eventRes = await fetch(`${API_ROOT}/events/manual`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${tempToken}`
        },
        body: JSON.stringify(eventData)
      });
      
      if (!eventRes.ok) {
        const errText = await eventRes.text().catch(() => "");
        throw new Error(`–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ—ó ${eventData.direction}: ${errText || eventRes.status}`);
      }
      
      const result = await eventRes.json();
      results.push(result);
    }
    
    // 7. –£—Å–ø—ñ—Ö!
    closeManualConfirm();
    
    const infoEl = document.getElementById("manualInfo");
    let message = "";
    
    if (eventsToDelete.length > 0) {
      message += `üîÑ –ó–∞–º—ñ–Ω–µ–Ω–æ ${eventsToDelete.length} —Å—Ç–∞—Ä–∏—Ö –ø–æ–¥—ñ–π. `;
    }
    
    if (results.length === 1) {
      const dir = results[0].direction === 'IN' ? '–≤—Ö–æ–¥—É' : '–≤–∏—Ö–æ–¥—É';
      message += `‚úÖ –ü–æ–¥—ñ—é ${dir} —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ! ID: ${results[0].id}`;
    } else {
      message += `‚úÖ –ü–æ–¥—ñ—ó —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ! IN (ID: ${results[0].id}), OUT (ID: ${results[1].id})`;
    }
    
    infoEl.textContent = message;
    infoEl.style.display = "block";
    
    // 8. –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É —ñ –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
    clearManualForm();
    await loadManualEvents();
    
  } catch (e) {
    errorEl.textContent = String(e.message || e);
    errorEl.style.display = "block";
  }
}

async function loadManualEvents() {
  try {
    const res = await apiFetch("/events/manual?limit=20");
    if (!res.ok) {
      console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä—É—á–Ω—ñ –ø–æ–¥—ñ—ó");
      return;
    }
    
    const events = await res.json();
    const tbody = document.querySelector("#manualEventsTable tbody");
    if (!tbody) return;
    
    tbody.innerHTML = "";
    
    if (!events || events.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" style="text-align:center; color:var(--muted);">–ù–µ–º–∞—î —Ä—É—á–Ω–∏—Ö –ø–æ–¥—ñ–π</td>`;
      tbody.appendChild(tr);
      return;
    }
    
    events.forEach(e => {
      const tr = document.createElement("tr");
      const ts = e.ts_local || e.timestamp || e.ts;
      const employee = e.employee_full_name || `ID: ${e.employee_id}`;
      const admin = e.created_by_username || "‚Äî";
      const comment = e.comment || "‚Äî";
      
      tr.innerHTML = `
        <td>${e.id}</td>
        <td>${escapeHtml(employee)}</td>
        <td>${fmtTime(ts)}</td>
        <td><span class="badge ${e.direction === 'IN' ? 'good' : 'warn'}">${e.direction}</span></td>
        <td>${escapeHtml(admin)}</td>
        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;" title="${escapeHtml(comment)}">${escapeHtml(comment)}</td>
      `;
      tbody.appendChild(tr);
    });
    
  } catch (e) {
    console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä—É—á–Ω–∏—Ö –ø–æ–¥—ñ–π:", e);
  }
}
  
  
  
  
  
  
  
  async function loadStats() {
    const empIdVal = document.getElementById("empSelect").value;
    const monthVal = document.getElementById("monthPick").value;

    if (!empIdVal) {
      alert("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞");
      return;
    }
    if (!monthVal) {
      alert("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å");
      return;
    }

    const range = monthToRange(monthVal);
    if (!range) {
      alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –º—ñ—Å—è—Ü—å");
      return;
    }

    document.getElementById("rangePreview").value = `${range.from} ‚Üí ${range.to}`;
    document.getElementById("statsInfo").textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶";

    try {
      // 1) EVENTS + INTERVALS
      let s1 = { events: [], intervals: [], has_open_shift: false };

      const res1 = await apiFetch(`/stats/employee/${empIdVal}`);
      if (res1.ok) {
        s1 = await res1.json();
      } else if (res1.status === 404) {
        s1 = { events: [], intervals: [], has_open_shift: false };
      } else {
        const txt = await res1.text().catch(() => "");
        throw new Error(`stats employee HTTP ${res1.status}\n${fmtJsonError(txt)}`);
      }

      renderEvents(s1.events || []);

      // 2) DAILY –ø–æ –º—ñ—Å—è—Ü—é
      let s2 = null;
      const res2 = await apiFetch(
        `/stats/employee/${empIdVal}/daily?from_date=${encodeURIComponent(range.from)}&to_date=${encodeURIComponent(range.to)}`
      );

      if (res2.ok) {
        s2 = await res2.json();
      } else if (res2.status === 404) {
        s2 = makeEmptyDaily(range.from, range.to);
      } else {
        const txt = await res2.text().catch(() => "");
        throw new Error(`stats daily HTTP ${res2.status}\n${fmtJsonError(txt)}`);
      }

// 3) SCHEDULE (–ø–ª–∞–Ω) - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π API –∑ –∞–≤—Ç–æ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º
      const [y, m] = monthVal.split("-").map(Number);
      
      const res3 = await apiFetch(`/schedule/month`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          year: y,
          month: m,
          employee_id: Number(empIdVal)
        })
      });      if (!res3.ok) {
        const txt = await res3.text().catch(() => "");
        throw new Error(`schedule HTTP ${res3.status}\n${fmtJsonError(txt)}`);
      }
      const sched = await res3.json();
      const scheduleMap = buildScheduleMap(sched);

      // 4) –ó–ª–∏—Ç—Ç—è daily + intervals + events
      const mergedItems = mergeDailyWithIntervals(
        s2.items || [],
        s1.intervals || [],
        s1.events || []
      );

      const allDaysItems = mergeDailyWithAllDays(range.from, range.to, mergedItems);

      // 5) –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ñ –ü–ª–∞–Ω/–§–∞–∫—Ç
      renderDailyPlanFact(allDaysItems, scheduleMap);

      // –ü—ñ–¥—Å—É–º–∫–∏
      renderAggregates(s2);

      // 6) –†–µ–Ω–¥–µ—Ä –ì–†–ê–§–Ü–ö–ê
      try {
        renderChart(allDaysItems, scheduleMap);
      } catch (e) {
        console.warn("–ü–æ–º–∏–ª–∫–∞ renderChart:", e);
      }

      // 7) UI —Å—Ç–∞—Ç—É—Å
      document.getElementById("statsInfo").textContent =
        `–ì–æ—Ç–æ–≤–æ. –ü–æ–¥—ñ—ó: ${(s1.events || []).length}, —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏: ${(s1.intervals || []).length}.`;
      setStatus(true, "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");

    } catch (err) {
      console.error(err);
      document.getElementById("statsInfo").textContent =
        `–ü–æ–º–∏–ª–∫–∞: ${String(err?.message || err)}`;
      setStatus(false, "–ü–æ–º–∏–ª–∫–∞");
    }
  }

  function renderChart(dailyItems, scheduleMap) {
    const canvas = document.getElementById("chartCanvas");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");

    if (chartInstance) {
      chartInstance.destroy();
      chartInstance = null;
    }

    const labels = [];
    const planData = [];
    const factData = [];

    (dailyItems || []).forEach(r => {
      const day = r.date_local || "";
      const sch = (scheduleMap && scheduleMap.get) ? (scheduleMap.get(day) || null) : null;

      labels.push(day);

      const planMinutes = (sch && sch.expected_minutes !== undefined && sch.expected_minutes !== null)
        ? sch.expected_minutes
        : null;

      const factWorked = (r.worked_minutes !== undefined && r.worked_minutes !== null)
        ? r.worked_minutes
        : null;

      planData.push(planMinutes !== null ? (planMinutes / 60) : 0);
      factData.push(factWorked !== null ? (factWorked / 60) : 0);
    });

    chartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "–ü–ª–∞–Ω (–≥–æ–¥)",
            data: planData,
            borderColor: "rgba(74,144,226,0.8)",
            backgroundColor: "rgba(74,144,226,0.2)",
            tension: 0.2
          },
          {
            label: "–§–∞–∫—Ç (–≥–æ–¥)",
            data: factData,
            borderColor: "rgba(45,204,112,0.8)",
            backgroundColor: "rgba(45,204,112,0.2)",
            tension: 0.2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            labels: { color: "rgba(255,255,255,0.88)" }
          }
        },
        scales: {
          x: {
            ticks: { color: "rgba(255,255,255,0.70)" },
            grid: { color: "rgba(255,255,255,0.08)" }
          },
          y: {
            ticks: { color: "rgba(255,255,255,0.70)" },
            grid: { color: "rgba(255,255,255,0.08)" },
            beginAtZero: true
          }
        }
      }
    });
  }

// ===== Schedule =====
let schedEmployeesFiltered = [];

function schedApplyFilter() {
  const q = (document.getElementById("schedSearch")?.value || "").trim().toLowerCase();
  schedEmployeesFiltered = !q ? [..._employeesCache] : _employeesCache.filter(e => {
    const hay = [e.id, e.full_name, e.nfc_uid, e.position, e.comment].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  });
  schedRenderEmpSelect();
}

function schedRenderEmpSelect() {
  const sel = document.getElementById("schedEmp");
  const keep = sel.value;
  sel.innerHTML = `<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å ‚Äî</option>`;
  
  (schedEmployeesFiltered || []).forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.id;
    opt.textContent = `${e.id} ‚Äî ${e.full_name}`;
    sel.appendChild(opt);
  });
  
  if (keep) sel.value = keep;
}

function schedInitFilters() {
  schedEmployeesFiltered = Array.isArray(_employeesCache) ? [..._employeesCache] : [];
  schedRenderEmpSelect();
  
  // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å
  const now = new Date();
  const schedMonth = document.getElementById("schedMonth");
  if (schedMonth) {
    schedMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,"0")}`;
  }
}

  function normalizeScheduleCell(v) {
    const s = (v || "").trim();
    if (!s) return { code: null, start_hhmm: null, end_hhmm: null };
    const m = s.match(/^(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})$/);
    if (m) return { code: null, start_hhmm: m[1], end_hhmm: m[2] };
    return { code: s, start_hhmm: null, end_hhmm: null };
  }

function onScheduleModeChange() {
  const mode = document.getElementById("schedMode").value;
  document.getElementById("scheduleWideBox").style.display = (mode === "all") ? "block" : "none";
  document.getElementById("scheduleMatrixBox").style.display = (mode === "single") ? "block" : "none";
  document.getElementById("schedSingleEmployeeBox").style.display = (mode === "single") ? "block" : "none";
}

async function loadSchedule() {
  const mode = document.getElementById("schedMode").value;
  const monthVal = document.getElementById("schedMonth").value;
  const empId = Number(document.getElementById("schedEmp").value || 0);

  if (!monthVal) {
    alert("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å");
    return;
  }

  const range = monthToRange(monthVal);
  if (!range) {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –º—ñ—Å—è—Ü—å");
    return;
  }

  if (mode === "single" && !empId) {
    alert("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞");
    return;
  }

  if (mode === "single") {
    // –†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞
    const [y, m] = monthVal.split("-").map(Number);
    
    const res = await apiFetch(`/schedule/month`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        year: y,
        month: m,
        employee_id: empId
      })
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`schedule HTTP ${res.status}\n${fmtJsonError(txt)}`);
    }
    const data = await res.json();

    const map = new Map();
    for (const it of (data.items || [])) {
      map.set(`${it.employee_id}|${it.day}`, scheduleCellText(it));
    }

    const dt = parseYmd(range.from);
    const monthStart = new Date(dt.getFullYear(), dt.getMonth(), 1);
    const monthEnd = new Date(dt.getFullYear(), dt.getMonth() + 1, 0);

    renderScheduleMatrix(empId, monthStart, monthEnd, map);

    document.getElementById("matrixHint").textContent =
      `${monthStart.toLocaleString("uk", { month: "long" })} ${monthStart.getFullYear()}`;
    return;
  }

  // –†–µ–∂–∏–º –≤—Å—ñ—Ö —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤
  const q = new URLSearchParams();
  q.set("date_from", range.from);
  q.set("date_to", range.to);

  const res = await apiFetch(`/schedule?${q.toString()}`);
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`schedule HTTP ${res.status}\n${fmtJsonError(txt)}`);
  }
  const data = await res.json();

  const map = new Map();
  for (const it of (data.items || [])) {
    map.set(`${it.employee_id}|${it.day}`, scheduleCellText(it));
  }

  const employees = _employeesCache;
  renderScheduleWideTable(employees, range.from, range.to, map);
}


  function renderScheduleWideTable(employees, from, to, map) {
    const days = eachDay(from, to);
    const thead = document.querySelector("#scheduleWideTable thead");
    const tbody = document.querySelector("#scheduleWideTable tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th style="min-width:40px;">‚Ññ</th>
      <th style="min-width:220px;">–ü–Ü–ë</th>
      <th style="min-width:160px;">–ü–æ—Å–∞–¥–∞</th>
      ${days.map(d => `<th style="min-width:60px;">${String(d.getDate()).padStart(2,"0")}</th>`).join("")}
    `;
    thead.appendChild(trh);

    employees.forEach((e, idx) => {
      const tr = document.createElement("tr");
      const cols = [];
      cols.push(`<td style="text-align:center;">${idx + 1}</td>`);
      cols.push(`<td>${e.full_name}</td>`);
      cols.push(`<td>${e.position || ""}</td>`);

      for (const d of days) {
        const dayStr = ymd(d);
        const key = `${e.id}|${dayStr}`;
        const val = map.get(key) || "";
        cols.push(`<td>${val}</td>`);
      }

      tr.innerHTML = cols.join("");
      tbody.appendChild(tr);
    });
  }

  function renderScheduleMatrix(employeeId, monthStart, monthEnd, map) {
    const thead = document.querySelector("#scheduleMatrix thead");
    const tbody = document.querySelector("#scheduleMatrix tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const trh = document.createElement("tr");
    trh.innerHTML = `<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>`;
    thead.appendChild(trh);

    const daysInMonth = monthEnd.getDate();
    const rows = Math.ceil(daysInMonth / 7);
    let day = 1;

    for (let r = 0; r < rows; r++) {
      const tr = document.createElement("tr");

      for (let c = 0; c < 7; c++) {
        if (day <= daysInMonth) {
          const d = new Date(monthStart.getFullYear(), monthStart.getMonth(), day);
          const dayStr = ymd(d);
          const key = `${employeeId}|${dayStr}`;
          const it = map.get(key) || "";

          let display = "";
          if (typeof it === "string") {
            display = it;
          } else if (it && it.start_hhmm) {
            display = `${it.start_hhmm}-${it.end_hhmm}`;
          } else if (it && it.code) {
            display = it.code;
          }

          const td = document.createElement("td");
          td.className = "matrix-cell";

          td.innerHTML = `
            <div class="daynum">
              <span>${day}</span><span class="muted small">${dayStr}</span>
            </div>
            <div class="shifttext">${display}</div>
          `;

          tr.appendChild(td);
          day++;
        } else {
          const td = document.createElement("td");
          td.className = "empty";
          td.textContent = "‚Äî";
          tr.appendChild(td);
        }
      }
      tbody.appendChild(tr);
    }
  }

async function openSchedulePdf() {
  const monthVal = document.getElementById("schedMonth").value;

  if (!monthVal) {
    alert("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å");
    return;
  }

  const range = monthToRange(monthVal);
  if (!range) {
    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –º—ñ—Å—è—Ü—å");
    return;
  }

  const from = range.from;
  const to = range.to;

    const res = await apiFetch(`/schedule/pdf?date_from=${encodeURIComponent(from)}&date_to=${encodeURIComponent(to)}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      alert(`–ü–æ–º–∏–ª–∫–∞ PDF: HTTP ${res.status}\n${fmtJsonError(txt)}`);
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
  }

  // ======================= PLAN BUILDER =======================

  let pbEmployeesFiltered = [];
  let pbSelected = new Set();
  let pbScheduleMap = new Map();
  let pbMonthRange = null;
  let pbCurrentEmpId = null;

  function pbInit() {
    pbEmployeesFiltered = Array.isArray(_employeesCache) ? [..._employeesCache] : [];
    pbRenderEmpSelect();

    const m = document.getElementById("pbMonth");
    if (m && !m.value) {
      const now = new Date();
      m.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,"0")}`;
    }

    pbSelected.clear();
    pbCurrentEmpId = null;
    pbScheduleMap = new Map();
    pbMonthRange = null;

    pbLoadMonth();
  }

  function pbRenderEmpSelect() {
    const sel = document.getElementById("pbEmpSelect");
    const keep = sel.value;
    sel.innerHTML = "";

    (pbEmployeesFiltered || []).forEach(e => {
      const opt = document.createElement("option");
      opt.value = String(e.id);
      opt.textContent = `${e.id} ‚Äî ${e.full_name}`;
      sel.appendChild(opt);
    });

    if (keep) sel.value = keep;
  }

  function pbApplyFilter() {
    const q = (document.getElementById("pbSearch")?.value || "").trim().toLowerCase();
    pbEmployeesFiltered = !q ? [..._employeesCache] : _employeesCache.filter(e => {
      const hay = [e.id, e.full_name, e.nfc_uid, e.position, e.comment].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });
    pbRenderEmpSelect();
  }

  function pbOnEmpPicked() {
    const sel = document.getElementById("pbEmpSelect");
    pbCurrentEmpId = sel && sel.value ? Number(sel.value) : null;
    pbReloadFromServer();
  }

  function pbMonthToRange(monthStr) {
    const [y, m] = String(monthStr || "").split("-").map(Number);
    if (!y || !m) return null;
    const last = new Date(y, m, 0).getDate();
    return { from: `${y}-${String(m).padStart(2,"0")}-01`, to: `${y}-${String(m).padStart(2,"0")}-${String(last).padStart(2,"0")}`, y, m };
  }

  function pbLoadMonth() {
    const monthVal = document.getElementById("pbMonth")?.value || "";
    pbMonthRange = pbMonthToRange(monthVal);
    pbSelected.clear();
    pbRenderMatrix();
  }

    function pbReloadFromServer() {
      if (!pbCurrentEmpId) {
        pbSetInfo("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞.");
        pbRenderMatrix();
        return;
      }
      if (!pbMonthRange) {
        pbSetInfo("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å.");
        pbRenderMatrix();
        return;
      }
      // –í–∏–∫–ª–∏–∫–∞—î–º–æ –∑ year —Ç–∞ month –∑–∞–º—ñ—Å—Ç—å from/to
      pbFetchScheduleForMonth(pbCurrentEmpId, pbMonthRange.y, pbMonthRange.m);
    }

  function pbSetInfo(msg) {
    const el = document.getElementById("pbInfo");
    if (el) el.textContent = msg;
  }

async function pbFetchScheduleForMonth(empId, year, month) {
  try {
    pbSetInfo("–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é —Ä–æ–∑–∫–ª–∞–¥ –∑ —Å–µ—Ä–≤–µ—Ä–∞ (–∞–≤—Ç–æ—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—É—Å—Ç–∏—Ö –≥—Ä–∞—Ñ—ñ–∫—ñ–≤)...");
    
    const res = await apiFetch(`/schedule/month`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        year: year,
        month: month,
        employee_id: empId
      })
    });
if (!res.ok) {
      const txt = await res.text().catch(() => "");
      pbSetInfo(`–ü–æ–º–∏–ª–∫–∞ /schedule/month: HTTP ${res.status} ${fmtJsonError(txt)}`);
        pbScheduleMap = new Map();
        pbRenderMatrix();
        return;
      }

      const data = await res.json();
      pbScheduleMap = new Map();
      for (const it of (data.items || [])) {
        pbScheduleMap.set(it.day, {
          text: scheduleCellText(it),
          start_hhmm: it.start_hhmm || null,
          end_hhmm: it.end_hhmm || null,
          code: it.code || null
        });
      }

    pbSetInfo("‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—É—Å—Ç—ñ –≥—Ä–∞—Ñ—ñ–∫–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –í–∏–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–π—Ç–µ —á–∞—Å/–≤–∏—Ö—ñ–¥–Ω–∏–π.");
      pbRenderMatrix();
    } catch (e) {
      pbSetInfo(`–ü–æ–º–∏–ª–∫–∞: ${String(e?.message || e)}`);
      pbScheduleMap = new Map();
      pbRenderMatrix();
    }
  }

  function pbRenderMatrix() {
    const thead = document.querySelector("#pbMatrix thead");
    const tbody = document.querySelector("#pbMatrix tbody");
    if (!thead || !tbody) return;

    thead.innerHTML = "";
    tbody.innerHTML = "";

    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th style="min-width:98px;">–ü–Ω</th>
      <th style="min-width:98px;">–í—Ç</th>
      <th style="min-width:98px;">–°—Ä</th>
      <th style="min-width:98px;">–ß—Ç</th>
      <th style="min-width:98px;">–ü—Ç</th>
      <th style="min-width:98px;">–°–±</th>
      <th style="min-width:98px;">–ù–¥</th>
    `;
    thead.appendChild(trh);

    if (!pbMonthRange) return;

    const y = pbMonthRange.y;
    const m1 = pbMonthRange.m;
    const daysTotal = new Date(y, m1, 0).getDate();

    const first = new Date(y, m1 - 1, 1);
    const firstDow = (first.getDay() + 6) % 7;

    const totalCells = firstDow + daysTotal;
    const rows = Math.ceil(totalCells / 7);

    let day = 1;
    for (let r = 0; r < rows; r++) {
      const tr = document.createElement("tr");

      for (let c = 0; c < 7; c++) {
        const cellIndex = r * 7 + c;

        if (cellIndex < firstDow || day > daysTotal) {
          const td = document.createElement("td");
          td.className = "empty";
          td.textContent = "‚Äî";
          tr.appendChild(td);
          continue;
        }

        const dateStr = `${y}-${String(m1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
        const sch = pbScheduleMap.get(dateStr) || null;

        const selected = pbSelected.has(dateStr);
        const td = document.createElement("td");
        td.className = "pb-cell" + (selected ? " selected" : "");
        td.dataset.day = dateStr;
        td.onclick = () => pbToggleDay(dateStr);

const text = sch ? (sch.text || "") : "";
// –Ø–∫—â–æ —Ç–µ–∫—Å—Ç —Ü–µ 00:00-00:00, –∑–∞–º—ñ–Ω—é—î–º–æ –Ω–∞ –ø—Ä–æ—á–µ—Ä–∫
const displayText = (text === "00:00-00:00") ? "‚Äî" : text;
const shiftLabel = displayText ? escapeHtml(displayText) : "‚Äî";
const muted0 = (!displayText || displayText === "‚Äî" || displayText === "0") ? "muted0" : "";

        td.innerHTML = `
          <div class="pb-check">${selected ? "‚úì" : ""}</div>
          <div class="daynum"><span>${day}</span><span class="muted small">${dateStr}</span></div>
          <div class="pb-shift ${muted0}">${shiftLabel}</div>
        `;

        tr.appendChild(td);
        day++;
      }

      tbody.appendChild(tr);
    }
  }

  function pbToggleDay(dayStr) {
    if (pbSelected.has(dayStr)) pbSelected.delete(dayStr);
    else pbSelected.add(dayStr);
    pbRenderMatrix();
  }

  function pbSelectAll() {
    if (!pbMonthRange) return;
    const { y, m } = pbMonthRange;
    const last = new Date(y, m, 0).getDate();
    pbSelected.clear();
    for (let d = 1; d <= last; d++) {
      pbSelected.add(`${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`);
    }
    pbRenderMatrix();
  }

  function pbClearSelection() {
    pbSelected.clear();
    pbRenderMatrix();
  }

  function pbApplyToSelected() {
    if (!pbSelected.size) { pbSetInfo("–í–∏–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ."); return; }

    const off = document.getElementById("pbDayOff").checked;
    const st = document.getElementById("pbStart").value.trim();
    const en = document.getElementById("pbEnd").value.trim();

    if (!off && !st && !en) {
      pbSetInfo("–í–≤–µ–¥—ñ—Ç—å —á–∞—Å –∞–±–æ –ø–æ–∑–Ω–∞—á—Ç–µ –≤–∏—Ö—ñ–¥–Ω–∏–π.");
      return;
    }

    for (const d of pbSelected) {
      if (off) {
        pbScheduleMap.set(d, { text: "–í", code: "–í", start_hhmm: null, end_hhmm: null });
      } else {
        pbScheduleMap.set(d, { text: `${st}-${en}`, code: null, start_hhmm: st, end_hhmm: en });
      }
    }

    pbRenderMatrix();
    pbSetInfo("–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ. –¢–µ–ø–µ—Ä –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –ó–±–µ—Ä–µ–≥—Ç–∏.");
  }

function pbClearSelectedCells() {
  if (!pbSelected.size) { pbSetInfo("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ."); return; }
  
  // –ó–∞–º—ñ—Å—Ç—å –≤–∏–¥–∞–ª–µ–Ω–Ω—è - —Å—Ç–∞–≤–∏–º–æ 00:00-00:00 (–ø—É—Å—Ç–∏–π –≥—Ä–∞—Ñ—ñ–∫)
  for (const dayStr of pbSelected) {
    pbScheduleMap.set(dayStr, {
      text: "‚Äî",
      code: null,
      start_hhmm: "00:00",
      end_hhmm: "00:00"
    });
  }
  
  pbSetInfo("–û—á–∏—â–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å \"–ó–±–µ—Ä–µ–≥—Ç–∏\", —â–æ–± –æ–Ω–æ–≤–∏—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.");
  pbRenderMatrix();
}

async function pbSaveSelected() {
  if (!pbCurrentEmpId) { pbSetInfo("–û–±–µ—Ä—ñ—Ç—å –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞."); return; }
  if (!pbSelected.size) { pbSetInfo("–ù–µ–º–∞—î –≤–∏–±—Ä–∞–Ω–∏—Ö –¥–Ω—ñ–≤."); return; }
  if (!pbMonthRange) { pbSetInfo("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å."); return; }

  pbSetInfo("–ó–±–µ—Ä—ñ–≥–∞—é...");

  let successCount = 0;
  let errorCount = 0;

  for (const day of pbSelected) {
    const raw = pbScheduleMap.get(day);
    
    if (!raw) {
      console.warn(`–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è ${day}, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ`);
      continue;
    }

    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–∞–Ω—ñ –Ω–∞–ø—Ä—è–º—É –∑ pbScheduleMap
    const payload = {
      employee_id: pbCurrentEmpId,
      day: day,
      code: raw.code || null,
      start_hhmm: raw.start_hhmm || null,
      end_hhmm: raw.end_hhmm || null
    };

    console.log('–ó–±–µ—Ä—ñ–≥–∞—é:', payload); // –î–ª—è –¥–µ–±–∞–≥—É

    const r = await postScheduleCellPB(payload);
    if (!r.ok) {
      pbSetInfo(`–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–ª—è ${day}:\n${r.error}`);
      errorCount++;
      // –ù–µ –ø—Ä–∏–ø–∏–Ω—è—î–º–æ, –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ —ñ–Ω—à—ñ
    } else {
      successCount++;
    }
  }

  // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞
  const res = await apiFetch(`/schedule/month`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      year: pbMonthRange.y,
      month: pbMonthRange.m,
      employee_id: pbCurrentEmpId
    })
  });

  if (!res.ok) {
    pbSetInfo(`–ó–±–µ—Ä–µ–∂–µ–Ω–æ ${successCount}, –ø–æ–º–∏–ª–æ–∫: ${errorCount}. –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ.`);
    return;
  }

  const data = await res.json();
  pbScheduleMap = new Map();

  for (const it of (data.items || [])) {
    pbScheduleMap.set(it.day, {
      text: it.code ? it.code : `${it.start_hhmm || ""}${it.end_hhmm ? "-" + it.end_hhmm : ""}`,
      code: it.code || null,
      start_hhmm: it.start_hhmm || null,
      end_hhmm: it.end_hhmm || null
    });
  }

  pbRenderMatrix();
  pbSetInfo(`‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ: ${successCount}, –ø–æ–º–∏–ª–æ–∫: ${errorCount}`);
}


function normalizePbCell(input) {
    const v = String(input || "").trim();
    if (!v) return { code: null, start_hhmm: null, end_hhmm: null };

    const m = v.match(/^(\d{2}:\d{2})-(\d{2}:\d{2})$/);
    if (m) {
      return { code: null, start_hhmm: m[1], end_hhmm: m[2] };
    }
    return { code: v, start_hhmm: null, end_hhmm: null };
  }

async function postScheduleCellPB(payload) {
  try {
    console.log('POST /schedule/cell:', JSON.stringify(payload)); // –î–ª—è –¥–µ–±–∞–≥—É
    
    const res = await apiFetch(`/schedule/cell`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:', txt); // –î–ª—è –¥–µ–±–∞–≥—É
      return { ok: false, error: `HTTP ${res.status}\n${fmtJsonError(txt)}` };
    }

    return { ok: true };
  } catch (e) {
    console.error('Exception:', e); // –î–ª—è –¥–µ–±–∞–≥—É
    return { ok: false, error: String(e?.message || e) };
  }
}

  // ===== Schedule viewing (moved to Stats tab) =====
  async function loadScheduleView() {
    const empIdVal = document.getElementById("empSelect").value;
    const monthVal = document.getElementById("monthPick").value;

    if (!empIdVal) {
      alert("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞");
      return;
    }
    if (!monthVal) {
      alert("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å");
      return;
    }

    const range = monthToRange(monthVal);
    if (!range) {
      alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –º—ñ—Å—è—Ü—å");
      return;
    }

    const dt = parseYmd(range.from);
    const monthStart = new Date(dt.getFullYear(), dt.getMonth(), 1);
    const monthEnd = new Date(dt.getFullYear(), dt.getMonth() + 1, 0);

    const q = new URLSearchParams();
    q.set("date_from", ymd(monthStart));
    q.set("date_to", ymd(monthEnd));
    q.set("employee_id", String(empIdVal));

    try {
      const res = await apiFetch(`/schedule?${q.toString()}`);
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`schedule HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }
      const data = await res.json();

      const map = new Map();
      for (const it of (data.items || [])) {
        map.set(`${it.employee_id}|${it.day}`, scheduleCellText(it));
      }

      renderScheduleMatrixInStats(empIdVal, monthStart, monthEnd, map);

      document.getElementById("scheduleMatrixBox").style.display = "block";
      document.getElementById("matrixHint").textContent =
        `${monthStart.toLocaleString("uk", { month: "long" })} ${monthStart.getFullYear()}`;
    } catch (e) {
      alert(`–ü–æ–º–∏–ª–∫–∞: ${String(e?.message || e)}`);
    }
  }

  function renderScheduleMatrixInStats(employeeId, monthStart, monthEnd, map) {
    const thead = document.querySelector("#scheduleMatrix thead");
    const tbody = document.querySelector("#scheduleMatrix tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const trh = document.createElement("tr");
    trh.innerHTML = `<th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>`;
    thead.appendChild(trh);

    const daysInMonth = monthEnd.getDate();
    const rows = Math.ceil(daysInMonth / 7);
    let day = 1;

    for (let r = 0; r < rows; r++) {
      const tr = document.createElement("tr");

      for (let c = 0; c < 7; c++) {
        if (day <= daysInMonth) {
          const d = new Date(monthStart.getFullYear(), monthStart.getMonth(), day);
          const dayStr = ymd(d);
          const key = `${employeeId}|${dayStr}`;
          const it = map.get(key) || "";

          let display = "";
          if (typeof it === "string") {
            display = it;
          } else if (it && it.start_hhmm) {
            display = `${it.start_hhmm}-${it.end_hhmm}`;
          } else if (it && it.code) {
            display = it.code;
          }

          const td = document.createElement("td");
          td.className = "matrix-cell";

          td.innerHTML = `
            <div class="daynum">
              <span>${day}</span><span class="muted small">${dayStr}</span>
            </div>
            <div class="shifttext">${display}</div>
          `;

          tr.appendChild(td);
          day++;
        } else {
          const td = document.createElement("td");
          td.className = "empty";
          td.textContent = "‚Äî";
          tr.appendChild(td);
        }
      }
      tbody.appendChild(tr);
    }
  }

  async function openSchedulePdfFromStats() {
    const monthVal = document.getElementById("monthPick").value;
    if (!monthVal) {
      alert("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å");
      return;
    }

    const range = monthToRange(monthVal);
    if (!range) {
      alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –º—ñ—Å—è—Ü—å");
      return;
    }

    const res = await apiFetch(`/schedule/pdf?date_from=${encodeURIComponent(range.from)}&date_to=${encodeURIComponent(range.to)}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      alert(`–ü–æ–º–∏–ª–∫–∞ PDF: HTTP ${res.status}\n${fmtJsonError(txt)}`);
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
  }

  // ===== INIT =====
  window.addEventListener("DOMContentLoaded", async () => {
    initPositionSelect();

    const now = new Date();
    const monthPick = document.getElementById("monthPick");
    if (monthPick) {
      monthPick.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,"0")}`;
    }

    const token = getToken();
    if (token) {
      setStatus(null, "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...");
      try {
        await loadEmployees();
      } catch (e) {
        console.error(e);
        setStatus(false, "–ü–æ–º–∏–ª–∫–∞");
      }
    } else {
      setStatus(false, "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
    }
  });
  
  
  async function checkExistingEvents() {
  const empId = document.getElementById("manualEmpSelect").value;
  const dateVal = document.getElementById("manualDate").value;
  const addBoth = document.getElementById("manualAddBothEvents").checked;
  const direction = document.getElementById("manualDirection").value;
  
  const warningEl = document.getElementById("manualWarning");
  const warningText = document.getElementById("manualWarningText");
  
  if (!empId || !dateVal) {
    warningEl.style.display = "none";
    return;
  }
  
  try {
    const token = getToken();
    if (!token) return;
    
    const res = await fetch(
      `${API_ROOT}/events/manual/date/${empId}/${dateVal}`,
      { headers: { "Authorization": `Bearer ${token}` } }
    );
    
    if (!res.ok) return;
    
    const data = await res.json();
    const existing = data.events || [];
    
    if (existing.length === 0) {
      warningEl.style.display = "none";
      return;
    }
    
    // –í–∏–∑–Ω–∞—á–∏—Ç–∏ —â–æ –±—É–¥–µ –∑–∞–º—ñ–Ω–µ–Ω–æ
    let toReplace = [];
    
    if (addBoth) {
      const hasIn = existing.some(e => e.direction === "IN");
      const hasOut = existing.some(e => e.direction === "OUT");
      if (hasIn) toReplace.push("–í–•–Ü–î");
      if (hasOut) toReplace.push("–í–ò–•–Ü–î");
    } else {
      const hasTarget = existing.some(e => e.direction === direction);
      if (hasTarget) {
        toReplace.push(direction === "IN" ? "–í–•–Ü–î" : "–í–ò–•–Ü–î");
      }
    }
    
    if (toReplace.length > 0) {
      warningText.textContent = `–ù–∞ —Ü—é –¥–∞—Ç—É –≤–∂–µ —î –ø–æ–¥—ñ—ó: ${toReplace.join(" —Ç–∞ ")}. –í–æ–Ω–∏ –±—É–¥—É—Ç—å –∑–∞–º—ñ–Ω–µ–Ω—ñ –Ω–æ–≤–∏–º–∏.`;
      warningEl.style.display = "block";
    } else {
      warningEl.style.display = "none";
    }
    
  } catch (e) {
    console.warn("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ—Å–Ω—É—é—á–∏—Ö –ø–æ–¥—ñ–π:", e);
    warningEl.style.display = "none";
  }
}

// –î–æ–¥–∞—Ç–∏ —Å–ª—É—Ö–∞—á—ñ
document.addEventListener("DOMContentLoaded", () => {
  const empSelect = document.getElementById("manualEmpSelect");
  const dateInput = document.getElementById("manualDate");
  const bothCheckbox = document.getElementById("manualAddBothEvents");
  const directionSelect = document.getElementById("manualDirection");
  
  if (empSelect) empSelect.addEventListener("change", checkExistingEvents);
  if (dateInput) dateInput.addEventListener("change", checkExistingEvents);
  if (bothCheckbox) bothCheckbox.addEventListener("change", checkExistingEvents);
  if (directionSelect) directionSelect.addEventListener("change", checkExistingEvents);
});
  
  
  
  
  
</script>

</body>
</html>