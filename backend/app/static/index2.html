<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –¢–∞–π–º-—Ç—Ä–µ–∫–µ—Ä</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel-2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.60);
      --muted-2: rgba(255,255,255,0.45);
      --accent: #4a90e2;
      --accent-2: #6aa8ff;
      --ok: #2dcc70;
      --bad: #ff4d4d;
      --warn: #ffd166;
      --shadow: 0 12px 30px rgba(0,0,0,0.35);
      --shadow-soft: 0 8px 20px rgba(0,0,0,0.22);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 10px;
      --focus: 0 0 0 3px rgba(74,144,226,0.35);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      padding: 20px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 12% -10%, rgba(74,144,226,0.35), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(106,168,255,0.18), transparent 60%),
        radial-gradient(1000px 650px at 60% 120%, rgba(45,204,112,0.10), transparent 60%),
        linear-gradient(180deg, #070b14 0%, #0b1220 55%, #0a1020 100%);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
      padding: 14px 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
      backdrop-filter: blur(10px);
    }

    h1{
      margin:0;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 18px;
      line-height: 1.2;
    }

    .muted{ color: var(--muted); font-size: 12px; }
    .muted.small{ color: var(--muted-2); font-size: 11px; }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      font-size: 12px;
      backdrop-filter: blur(8px);
    }

    .dot{
      width: 9px; height: 9px; border-radius: 99px;
      background: rgba(255,255,255,0.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.05);
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 4px rgba(45,204,112,0.15); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(255,77,77,0.15); }

    .btn{
      cursor:pointer;
      border: 1px solid transparent;
      background: linear-gradient(180deg, var(--accent-2), var(--accent));
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease, background .12s ease;
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 10px 20px rgba(74,144,226,0.18);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(0.99); }
    .btn:focus{ outline:none; box-shadow: var(--focus), 0 10px 22px rgba(74,144,226,0.18); }

    .btn.secondary{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: 0 10px 20px rgba(0,0,0,0.18);
    }
    .btn.secondary:hover{
      background: rgba(255,255,255,0.10);
      filter:none;
    }

    .tabs{
      display:flex;
      gap: 10px;
      margin: 12px 0 16px;
      flex-wrap: wrap;
    }
    .tab-btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      padding: 10px 14px;
      border-radius: 999px;
      cursor:pointer;
      transition: 0.18s;
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      box-shadow: 0 8px 18px rgba(0,0,0,0.14);
      backdrop-filter: blur(8px);
    }
    .tab-btn:hover{
      background: rgba(255,255,255,0.10);
      transform: translateY(-1px);
    }
    .tab-btn.active{
      background: linear-gradient(180deg, rgba(74,144,226,0.9), rgba(74,144,226,0.55));
      border-color: rgba(74,144,226,0.55);
      box-shadow: 0 12px 24px rgba(74,144,226,0.16);
    }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .row{ display:flex; gap: 18px; align-items:flex-start; flex-wrap:wrap; }
    .col{ flex:1; min-width: 320px; }

    .box{
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
    }

    table{
      border-collapse: collapse;
      width: 100%;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
    }

    th, td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 10px 12px;
      text-align: left;
      font-size: 13px;
      color: var(--text);
    }
    th{
      background: rgba(255,255,255,0.08);
      font-weight: 900;
      color: rgba(255,255,255,0.88);
      letter-spacing: .2px;
    }
    tr:hover{ background: rgba(255,255,255,0.05); cursor:pointer; }

    label{
      display:block;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    input, textarea, select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(10,16,32,0.55);
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    input::placeholder{ color: rgba(255,255,255,0.40); }

    input:focus, textarea:focus, select:focus{
      border-color: rgba(74,144,226,0.65);
      box-shadow: var(--focus);
      background: rgba(10,16,32,0.72);
    }

    textarea{ min-height: 92px; resize: vertical; }

    select{ appearance: none; background-image:
      linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.6) 50%),
      linear-gradient(135deg, rgba(255,255,255,0.6) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 12px) calc(50% - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 34px;
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    canvas{
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
    }

    .sched-wrap{ overflow:auto; }
    #scheduleWideTable th, #scheduleWideTable td{ text-align:center; white-space:nowrap; }

    #scheduleMatrix th, #scheduleMatrix td{ text-align:center; white-space:nowrap; }
    #scheduleMatrix td.matrix-cell{
      cursor:pointer;
      font-weight:900;
      vertical-align: top;
      min-width: 92px;
      height: 66px;
      background: rgba(255,255,255,0.03);
    }
    #scheduleMatrix td.matrix-cell:hover{ background: rgba(74,144,226,0.14); }

    .daynum{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,0.95);
      margin-bottom: 4px;
      gap: 8px;
    }
    .shifttext{
      font-weight: 850;
      font-size: 12px;
      color: rgba(255,255,255,0.88);
    }
    .empty{
      background: rgba(255,255,255,0.02);
      color: rgba(255,255,255,0.35);
      cursor: default !important;
    }

    /* daily */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      font-size: 11px;
      font-weight: 900;
      margin-left: 6px;
      line-height: 1.4;
      white-space: nowrap;
    }
    .badge.open{ color: var(--warn); border-color: rgba(255,209,102,.35); }
    .badge.auto{ color: #8fd3ff; border-color: rgba(143,211,255,.35); }
    .badge.warn{ color: #ff8b8b; border-color: rgba(255,139,139,.35); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      font-size: 11px;
      font-weight: 900;
      white-space: nowrap;
    }
    .pill.warn{ color: var(--warn); border-color: rgba(255,209,102,.35); }
    .pill.viol{ color: #ff8b8b; border-color: rgba(255,139,139,.35); }

    .pill.good{ color: var(--ok); border-color: rgba(45,204,112,.35); }
    .pill.bad{ color: #ff8b8b; border-color: rgba(255,139,139,.35); }
    .pill.neutral{ color: rgba(255,255,255,0.75); border-color: rgba(255,255,255,.18); }

    tr.row-open{ background: rgba(255,209,102,.06); }
    tr.row-warn{ background: rgba(255,77,77,.06); }

    details summary{
      cursor:pointer;
      font-weight: 950;
      color: rgba(255,255,255,0.88);
      margin-top: 6px;
    }

    .modal-backdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,0.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width: 100%;
      max-width: 460px;
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .modal-header{
      padding: 14px 16px;
      background: rgba(255,255,255,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .modal-title{
      font-weight: 950;
      font-size: 14px;
      color: rgba(255,255,255,0.92);
    }
    .modal-body{ padding: 16px; }
    .modal-actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }

    .error{
      margin-top: 10px;
      background: rgba(255,77,77,0.10);
      border: 1px solid rgba(255,77,77,0.25);
      color: rgba(255,225,225,0.95);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      display:none;
      white-space: pre-wrap;
    }

    .info{
      margin-top: 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.78);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      white-space: pre-wrap;
    }

    @media (max-width: 520px){
      body{ padding: 14px; }
      .grid2{ grid-template-columns: 1fr; }
      .topbar{ padding: 12px; }
      .btn{ width: 100%; }
    }
    
    
    
    
    
    
    
 /* Plan Builder matrix */
#pbMatrix th, #pbMatrix td { text-align:center; white-space:nowrap; }
#pbMatrix td.pb-cell{
  position: relative;
  cursor: pointer;
  vertical-align: top;
  min-width: 98px;
  height: 74px;
  background: rgba(255,255,255,0.03);
}
#pbMatrix td.pb-cell:hover{ background: rgba(74,144,226,0.14); }
#pbMatrix td.pb-cell.selected{
  outline: 2px solid rgba(74,144,226,0.65);
  box-shadow: 0 0 0 3px rgba(74,144,226,0.20);
}
.pb-check{
  position:absolute;
  top:8px; right:8px;
  width: 18px; height: 18px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(0,0,0,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 12px;
  font-weight: 900;
  color: rgba(255,255,255,0.92);
}
.pb-cell.selected .pb-check{
  background: rgba(74,144,226,0.30);
  border-color: rgba(74,144,226,0.55);
}
.pb-shift{
  font-weight: 900;
  margin-top: 6px;
}
.pb-shift.muted0{
  color: rgba(255,255,255,0.40);
}
  
  
  
  
  
  
  
  
  
  
  </style>
</head>

<body>

  <div class="topbar">
    <div>
      <h1>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h1>
      <div class="muted">–ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –≤ UTC; –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ (Europe/Warsaw).</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <div class="status-pill" title="–°—Ç–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —Ç–∞ API">
        <span id="statusDot" class="dot"></span>
        <span id="statusText">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ</span>
      </div>
      <button class="btn secondary" onclick="openLogin()">–£–≤—ñ–π—Ç–∏</button>
      <button class="btn" onclick="logout()">–í–∏–π—Ç–∏</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="openTab('employees')">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</button>
    <button class="tab-btn" onclick="openTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    <button class="tab-btn" onclick="openTab('chartTab')">–ì—Ä–∞—Ñ—ñ–∫</button>
    <button class="tab-btn" onclick="openTab('scheduleTab')">–ì—Ä–∞—Ñ—ñ–∫ –∑–º—ñ–Ω</button>
  </div>

  <!-- ================= EMPLOYEES ================= -->
  <div id="employees" class="tab-content active">
    <div class="row">
      <div class="col">
        <div class="box">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div style="font-weight:950;">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</div>
            <button class="btn secondary" onclick="loadEmployees()">–û–Ω–æ–≤–∏—Ç–∏</button>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <input id="empSearch" placeholder="–ü–æ—à—É–∫: ID, –ü–Ü–ë, NFC, –ø–æ—Å–∞–¥–∞‚Ä¶" style="flex:1; min-width:240px;" oninput="applyEmployeeFilter()" />
            <button class="btn secondary" onclick="clearEmployeeSearch()">–°–∫–∏–Ω—É—Ç–∏</button>
          </div>
          <div class="muted" style="margin-top:6px;">
            –ü–æ—à—É–∫ —Ñ—ñ–ª—å—Ç—Ä—É—î —Ç–∞–±–ª–∏—Ü—é + —Å–ø–∏—Å–∫–∏ –≤–∏–±–æ—Ä—É —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞/–≥—Ä–∞—Ñ—ñ–∫ –∑–º—ñ–Ω).
          </div>
        </div>

        <table id="empTable">
          <thead>
            <tr><th>ID</th><th>–ü–Ü–ë</th><th>NFC UID</th><th>–ê–∫—Ç–∏–≤–Ω–∏–π</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="col">
        <div class="box">
          <div style="font-weight:950; margin-bottom:8px;">–°—Ç–≤–æ—Ä–∏—Ç–∏ / —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏</div>

          <input type="hidden" id="empId" />

          <label>–ü–Ü–ë</label>
          <input id="fullName" />

          <label>NFC UID</label>
          <input id="nfcUid" />

          <div class="grid2">
            <div>
              <label>–ü–æ—Å–∞–¥–∞</label>
              <select id="position"></select>
            </div>
            <div>
              <label style="margin-top: 10px;">
                <input type="checkbox" id="isActive" checked />
                –ê–∫—Ç–∏–≤–Ω–∏–π
              </label>
            </div>
          </div>

          <label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
          <textarea id="comment"></textarea>

          <label style="margin-top: 12px;">
            <input type="checkbox" id="editMode" />
            –†–µ–∂–∏–º —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (–∑ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è–º)
          </label>
          <div class="muted" style="margin-top:6px;">
            OFF ‚Üí ‚Äú–ó–±–µ—Ä–µ–≥—Ç–∏‚Äù –∑–∞–≤–∂–¥–∏ —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞.<br>
            ON ‚Üí –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –æ–±—Ä–∞–Ω–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ (–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ —Å–ø–∏—Ç–∞—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è).
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" onclick="saveEmployee()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="btn secondary" onclick="clearForm()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= STATS ================= -->
  <div id="stats" class="tab-content">
    <div class="row">
      <div class="col">
        <div class="box">
          <div style="font-weight:950;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ / –ü–ª–∞–Ω vs —Ñ–∞–∫—Ç</div>

          <label>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</label>
          <select id="empSelect"></select>

          <!-- ‚úÖ month picker instead of interval -->
          <div class="grid2">
            <div>
              <label>–ú—ñ—Å—è—Ü—å</label>
              <input id="monthPick" type="month" />
            </div>
            <div>
              <label>–î—ñ–∞–ø–∞–∑–æ–Ω (–∞–≤—Ç–æ)</label>
              <input id="rangePreview" type="text" readonly />
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" onclick="loadStats()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
            <button class="btn secondary" onclick="openTab('chartTab');">–î–æ –≥—Ä–∞—Ñ—ñ–∫–∞</button>
          </div>

          <div class="info" id="statsInfo">–ì–æ—Ç–æ–≤–æ.</div>
          <div class="info" id="aggInfo" style="display:none;"></div>
        </div>

        <div class="box">
          <div style="font-weight:950; margin-bottom:8px;">–ü–æ–¥—ñ—ó (IN/OUT)</div>
          <table id="eventsTable">
            <thead>
              <tr><th>ID</th><th>Dir</th><th>Local</th><th>Terminal</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="box">
          <div style="font-weight:950; margin-bottom:8px;">–î–Ω—ñ (–ü–ª–∞–Ω / –§–∞–∫—Ç / –†—ñ–∑–Ω–∏—Ü—è)</div>
          <table id="dailyTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>–ü–ª–∞–Ω</th>
                <th>–§–∞–∫—Ç</th>
                <th>–†—ñ–∑–Ω–∏—Ü—è</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="muted" style="margin-top:8px;">
            üü° open = —î IN –±–µ–∑ OUT ‚Ä¢ üîí auto = –∞–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è ‚Ä¢ ‚ö† warn = –∞–Ω–æ–º–∞–ª—ñ—ó ‚Ä¢ Œî = —Ñ–∞–∫—Ç ‚àí –ø–ª–∞–Ω
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= CHART ================= -->
  <div id="chartTab" class="tab-content">
    <div class="box">
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
              <button class="btn" onclick="openPlanBuilder()">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥—Ä–∞—Ñ—ñ–∫–∞</button>
              <button class="btn secondary" onclick="refreshChartOnly()">–û–Ω–æ–≤–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
            </div>
            
            <div class="info" id="chartInfo" style="margin-top:10px;">
              –¢—É—Ç –±—É–¥—É—î—Ç—å—Å—è Plan vs Fact –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ–∑–∫–ª–∞–¥—É (/schedule) —Ç–∞ —Ñ–∞–∫—Ç-–¥–∞–Ω–∏—Ö (/daily).
            </div>
        
      </div>
    </div>
  </div>

  <!-- ================= SCHEDULE ================= -->
  <div id="scheduleTab" class="tab-content">
    <div class="row">
      <div class="col">
        <div class="box">
          <div style="font-weight:950;">–ì—Ä–∞—Ñ—ñ–∫ –∑–º—ñ–Ω</div>

          <div class="grid2">
            <div>
              <label>–†–µ–∂–∏–º</label>
              <select id="schedMode" onchange="onScheduleModeChange()">
                <option value="all">–£—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</option>
                <option value="single">–û–¥–∏–Ω —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ (–º–∞—Ç—Ä–∏—Ü—è)</option>
              </select>
            </div>
            <div>
              <label>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</label>
              <select id="schedEmp"></select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>from_date</label>
              <input id="schedFrom" type="date" />
            </div>
            <div>
              <label>to_date</label>
              <input id="schedTo" type="date" />
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" onclick="loadSchedule()">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
            <button class="btn secondary" onclick="openSchedulePdf()">PDF</button>
          </div>

          <div class="info" style="margin-top:12px;">
            –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: —É–≤—ñ–º–∫–Ω–∏ —Ä–µ–∂–∏–º ‚Äú–û–¥–∏–Ω —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫‚Äù —ñ –∫–ª—ñ–∫–Ω–∏ –∫–ª—ñ—Ç–∏–Ω–∫—É ‚Üí –≤–≤–µ–¥–∏ <b>07:00-19:00</b> –∞–±–æ –∫–æ–¥ (<b>–í</b>, <b>–í—ñ–¥—Ä.</b>). –ü–æ—Ä–æ–∂–Ω—å–æ = –≤–∏–¥–∞–ª–∏—Ç–∏.
          </div>
        </div>

        <div class="box" id="scheduleWideBox">
          <div style="font-weight:950; margin-bottom:8px;">–¢–∞–±–µ–ª—å (—É—Å—ñ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏)</div>
          <div class="sched-wrap">
            <table id="scheduleWideTable">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="box" id="scheduleMatrixBox" style="display:none;">
          <div style="font-weight:950; margin-bottom:8px;">
            –ú–∞—Ç—Ä–∏—Ü—è –∑–º—ñ–Ω (7√ó4 + –∑–∞–ª–∏—à–æ–∫)
            <span class="muted" id="matrixHint" style="margin-left:8px;"></span>
          </div>
          <div class="sched-wrap">
            <table id="scheduleMatrix">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ================= LOGIN ================= -->
  <div id="loginBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title">–í—Ö—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
        <button class="btn secondary" onclick="closeLogin()">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
      <div class="modal-body">
        <label>–õ–æ–≥—ñ–Ω</label>
        <input id="loginInput" autocomplete="username" />

        <label>–ü–∞—Ä–æ–ª—å</label>
        <input id="passwordInput" type="password" autocomplete="current-password" />

        <div id="loginError" class="error"></div>
        <div class="info">
          –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –∑–∞—Ö–∏—â–µ–Ω–∏—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤ (require_admin).
          –ü—ñ—Å–ª—è –≤—Ö–æ–¥—É —Ç–æ–∫–µ–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ localStorage —ñ –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeLogin()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
      </div>
    </div>
  </div>

  
<!-- ================= PLAN BUILDER (modal) ================= -->
<div id="planBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" style="max-width: 860px;">
    <div class="modal-header">
      <div class="modal-title">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥—Ä–∞—Ñ—ñ–∫–∞ (–ø–ª–∞–Ω)</div>
      <button class="btn secondary" onclick="closePlanBuilder()">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>

    <div class="modal-body">
      <div class="grid2">
        <div>
          <label>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ (–ø–æ—à—É–∫)</label>
          <input id="pbSearch" placeholder="–í–≤–µ–¥–∏ –ü–Ü–ë / ID / NFC..." oninput="pbApplyFilter()" />
        </div>
        <div>
          <label>–°–ø–∏—Å–æ–∫</label>
          <select id="pbEmpSelect" onchange="pbOnEmpPicked()"></select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>–ú—ñ—Å—è—Ü—å</label>
          <input id="pbMonth" type="month" onchange="pbLoadMonth()" />
        </div>
        <div>
          <label>–®–≤–∏–¥–∫—ñ –¥—ñ—ó</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
            <button class="btn secondary" onclick="pbSelectAll()">–í–∏–±—Ä–∞—Ç–∏ –≤—Å–µ</button>
            <button class="btn secondary" onclick="pbClearSelection()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—ñ—Ä</button>
            <button class="btn secondary" onclick="pbReloadFromServer()">–ü—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞</button>
          </div>
        </div>
      </div>

      <div class="box" style="margin-top:12px; padding:12px;">
        <div class="grid2">
          <div>
            <label>–ß–∞—Å –ø–æ—á–∞—Ç–∫—É (HH:MM)</label>
            <input id="pbStart" placeholder="07:00" />
          </div>
          <div>
            <label>–ß–∞—Å –∫—ñ–Ω—Ü—è (HH:MM)</label>
            <input id="pbEnd" placeholder="19:00" />
          </div>
        </div>

        <label style="margin-top:10px;">
          <input type="checkbox" id="pbDayOff" />
          –ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ ‚Äú–≤–∏—Ö—ñ–¥–Ω–∏–π‚Äù –¥–ª—è –≤–∏–±—Ä–∞–Ω–∏—Ö –¥–Ω—ñ–≤
        </label>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn" onclick="pbApplyToSelected()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –¥–æ –≤–∏–±—Ä–∞–Ω–∏—Ö</button>
          <button class="btn secondary" onclick="pbClearSelectedCells()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ (–≤–∏–¥–∞–ª–∏—Ç–∏ –ø–ª–∞–Ω)</button>
          <button class="btn" onclick="pbSaveSelected()">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
        </div>

        <div class="info" id="pbInfo" style="margin-top:10px;">
          –ü–æ—Ä–∞–¥–∞: –≤–∏–±–µ—Ä–∏ –¥–Ω—ñ ‚Üí –≤–≤–µ–¥–∏ —á–∞—Å ‚Üí ‚Äú–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏‚Äù ‚Üí ‚Äú–ó–±–µ—Ä–µ–≥—Ç–∏‚Äù.
        </div>
      </div>

      <div class="sched-wrap" style="margin-top:10px;">
        <table id="pbMatrix">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn secondary" onclick="closePlanBuilder()">–ó–∞–∫—Ä–∏—Ç–∏</button>
      <button class="btn" onclick="pbSaveSelected()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>




<script>
  const API_ROOT = "/api";
  let chartInstance = null;

  // ===== positions list =====
  const POSITIONS = [
    "–ø—Ä–∏–±–∏—Ä–∞–ª—å–Ω–∏–∫ —Å–ª—É–∂–±–æ–≤–∏—Ö –ø—Ä–∏–º—ñ—â–µ–Ω—å",
    "–∫—É—Ö–∞—Ä-—É–Ω—ñ–≤–µ—Ä—Å–∞–ª",
    "–ø—Ä–æ–¥–∞–≤–µ—Ü—å-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç",
    "–ø—Ä–∏–π–º–∞–ª—å–Ω–∏–∫ —Å–∫–ª–∞–¥—É",
    "–≤–∞–Ω—Ç–∞–∂–Ω–∏–∫",
    "–∫–µ—Ä—É—é—á–∏–π –º–∞–≥–∞–∑–∏–Ω–æ–º",
    "–∑–∞—Å—Ç—É–ø–Ω–∏–∫ –∫–µ—Ä—É—é—á–æ–≥–æ",
  ];

  function setStatus(ok, text) {
    const dot = document.getElementById("statusDot");
    const t = document.getElementById("statusText");
    dot.classList.remove("ok", "bad");
    if (ok === true) dot.classList.add("ok");
    if (ok === false) dot.classList.add("bad");
    t.textContent = text;
  }

  function getToken() { return localStorage.getItem("admin_token") || ""; }
  function setToken(token) { localStorage.setItem("admin_token", token); }
  function clearToken() { localStorage.removeItem("admin_token"); }

  function openLogin() {
    document.getElementById("loginError").style.display = "none";
    document.getElementById("loginError").textContent = "";
    document.getElementById("loginBackdrop").classList.add("show");
    setTimeout(() => document.getElementById("loginInput").focus(), 0);
  }
  function closeLogin() { document.getElementById("loginBackdrop").classList.remove("show"); }

  function logout() {
    clearToken();
    setStatus(false, "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
    openLogin();
  }

  function extractToken(payload) {
    if (!payload) return "";
    if (typeof payload === "string") return payload.trim();
    if (payload.access_token) return String(payload.access_token).trim();
    if (payload.token) return String(payload.token).trim();
    if (payload.data && payload.data.access_token) return String(payload.data.access_token).trim();
    if (payload.data && payload.data.token) return String(payload.data.token).trim();
    return "";
  }

  async function login() {
    const loginVal = document.getElementById("loginInput").value.trim();
    const passVal  = document.getElementById("passwordInput").value;

    const errBox = document.getElementById("loginError");
    errBox.style.display = "none";
    errBox.textContent = "";

    if (!loginVal || !passVal) {
      errBox.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ª–æ–≥—ñ–Ω —ñ –ø–∞—Ä–æ–ª—å.";
      errBox.style.display = "block";
      return;
    }

    try {
      const res = await fetch(`${API_ROOT}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: loginVal, password: passVal })
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`Login HTTP ${res.status}\n${txt}`);
      }

      const payload = await res.json().catch(async () => await res.text());
      const token = extractToken(payload);
      if (!token) throw new Error("–í—Ö—ñ–¥ —É—Å–ø—ñ—à–Ω–∏–π, –∞–ª–µ —Ç–æ–∫–µ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ /api/login.");

      setToken(token);
      closeLogin();
      setStatus(true, "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
      await loadEmployees();
    } catch (e) {
      errBox.textContent = String(e?.message || e);
      errBox.style.display = "block";
      setStatus(false, "–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É");
    }
  }

  async function apiFetch(path, opts = {}) {
    const token = getToken();
    const headers = new Headers(opts.headers || {});
    if (token) headers.set("Authorization", `Bearer ${token}`);

    const res = await fetch(`${API_ROOT}${path}`, { ...opts, headers });

    if (res.status === 401) {
      setStatus(false, "401: –ø–æ—Ç—Ä—ñ–±–µ–Ω –≤—Ö—ñ–¥");
      openLogin();
    }
    return res;
  }

  function openTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');

    document.querySelectorAll('.tab-btn').forEach(b => {
      const onclick = b.getAttribute("onclick") || "";
      if (onclick.includes(`'${tabId}'`)) b.classList.add("active");
    });
  }

  function fmtJsonError(text) {
    if (!text) return "";
    if (text.length > 1200) return text.slice(0, 1200) + "\n...trimmed...";
    return text;
  }
    
    function fmtTime(ts) {
      if (!ts) return "";
    
      // —è–∫—â–æ –ø—Ä–∏–π—à–ª–æ "HH:MM" –∞–±–æ "HH:MM:SS" ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —è–∫ —î (–æ–±—Ä—ñ–∑–∞—î–º–æ –¥–æ HH:MM:SS)
      const s = String(ts).trim();
      const m = s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (m) {
        const hh = m[1], mm = m[2], ss = (m[3] ?? "00");
        return `${hh}:${mm}:${ss}`;
      }
    
      // ISO / datetime
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return ""; // –Ω–µ –≤–∞–ª–∏–º–æ—Å—å
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function toLocalMinutesAny(value) {
      if (!value) return null;
    
      const s = String(value).trim();
    
      // "HH:MM" –∞–±–æ "HH:MM:SS"
      const m = s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (m) {
        const hh = Number(m[1]), mm = Number(m[2]);
        if (hh > 23 || mm > 59) return null;
        return hh * 60 + mm;
      }
    
      // ISO / datetime
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return null;
      return d.getHours() * 60 + d.getMinutes();
    }
    
    function hhmmToMinutes(hhmm) {
      const s = String(hhmm || "").trim();
      const m = s.match(/^(\d{2}):(\d{2})$/);
      if (!m) return null;
      const hh = Number(m[1]), mm = Number(m[2]);
      if (hh > 23 || mm > 59) return null;
      return hh * 60 + mm;
    }
    
    function clamp0(n){ return Math.max(0, n); }
    
    // –Ω—ñ—á–Ω—ñ –∑–º—ñ–Ω–∏: —è–∫—â–æ —Ñ–∞–∫—Ç –º–µ–Ω—à–∏–π –∑–∞ —Å—Ç–∞—Ä—Ç ‚Äî –≤–≤–∞–∂–∞—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—é –¥–æ–±–æ—é
    function alignActualToShift(actualMin, expectedStartMin) {
      if (actualMin === null || expectedStartMin === null) return actualMin;
      if (actualMin < expectedStartMin) return actualMin + 24 * 60;
      return actualMin;
    }

  function escapeHtml(s) {
    return String(s)
      .split("&").join("&amp;")
      .split("<").join("&lt;")
      .split(">").join("&gt;")
      .split('"').join("&quot;")
      .split("'").join("&#039;");
  }

  // ===== Month helpers (step 2) =====
  function ymd(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function daysInMonth(year, month1based) {
    return new Date(year, month1based, 0).getDate();
  }
  function monthToRange(monthStr) {
    // monthStr: "YYYY-MM"
    const [y, m] = String(monthStr || "").split("-").map(Number);
    if (!y || !m) return null;
    const from = `${y}-${String(m).padStart(2,"0")}-01`;
    const to = `${y}-${String(m).padStart(2,"0")}-${String(daysInMonth(y, m)).padStart(2,"0")}`;
    return { from, to };
  }
  function parseHHMM(s) {
    const m = String(s || "").match(/^(\d{2}):(\d{2})$/);
    if (!m) return null;
    const hh = Number(m[1]), mm = Number(m[2]);
    if (hh > 23 || mm > 59) return null;
    return hh * 60 + mm;
  }
  function minutesToSignedLabel(mins) {
    if (mins === null || mins === undefined) return "";
    const sign = mins > 0 ? "+" : (mins < 0 ? "‚àí" : "");
    const a = Math.abs(mins);
    const hh = Math.floor(a / 60);
    const mm = a % 60;
    if (hh === 0) return `${sign}${mm} —Ö–≤`;
    return `${sign}${hh}–≥ ${String(mm).padStart(2,"0")}—Ö–≤`;
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

function hhmmToMinutes(hhmm) {
  const m = String(hhmm || "").match(/^(\d{2}):(\d{2})$/);
  if (!m) return null;
  const hh = Number(m[1]), mm = Number(m[2]);
  if (hh > 23 || mm > 59) return null;
  return hh * 60 + mm;
}

function minutesToHHMM(totalMin) {
  if (totalMin === null || totalMin === undefined) return "";
  totalMin = ((totalMin % (24*60)) + (24*60)) % (24*60);
  const hh = Math.floor(totalMin / 60);
  const mm = totalMin % 60;
  return `${pad2(hh)}:${pad2(mm)}`;
}

function clamp0(n){ return Math.max(0, n); }

function toLocalMinutesFromTs(ts) {
  if (!ts) return null;
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return null;
  return d.getHours() * 60 + d.getMinutes();
}

// –î–ª—è –Ω—ñ—á–Ω–æ—ó –∑–º—ñ–Ω–∏: —è–∫—â–æ actual < expected_start ‚Äî –¥–æ–¥–∞—î–º–æ +24h (—Ç–æ–±—Ç–æ –Ω–∞—Å—Ç—É–ø–Ω–∞ –¥–æ–±–∞)
function alignActualToShift(actualMin, expectedStartMin) {
  if (actualMin === null || expectedStartMin === null) return actualMin;
  if (actualMin < expectedStartMin) return actualMin + 24*60;
  return actualMin;
}


async function safeJson(res) {
  const txt = await res.text().catch(() => "");
  try { return JSON.parse(txt); } catch { return txt || null; }
}

function makeEmptyDaily(from, to) {
  // —Ä–æ–±–∏–º–æ items –Ω–∞ –∫–æ–∂–µ–Ω –¥–µ–Ω—å, —â–æ–± –≥—Ä–∞—Ñ—ñ–∫ –Ω–µ –±—É–≤ –ø—É—Å—Ç–∏–π
  const items = [];
  const days = eachDay(from, to); // —É —Ç–µ–±–µ –≤–∂–µ —î eachDay(from,to)
  for (const d of days) {
    const day = ymd(d);
    items.push({
      date_local: day,
      worked_minutes: 0,
      worked_hms: "00:00:00",
      first_in_local: null,
      last_out_local: null,
      open_shift: false,
      auto_closed: false,
      anomalies: []
    });
  }
  return { items, total_minutes: 0, total_hms: "00:00:00", weeks: [], months: [] };
}

  
  // ====== Employee search/filter/cache ======
  let _employeesCache = [];

  function clearEmployeeSearch() {
    const inp = document.getElementById("empSearch");
    if (inp) inp.value = "";
    applyEmployeeFilter();
  }

  function applyEmployeeFilter() {
    const inp = document.getElementById("empSearch");
    const q = (inp?.value || "").trim().toLowerCase();

    const filtered = !q ? _employeesCache : _employeesCache.filter(e => {
      const hay = [e.id, e.full_name, e.nfc_uid, e.position, e.comment].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });

    renderEmployeesTableAndSelects(filtered);
  }

  function initPositionSelect() {
    const sel = document.getElementById("position");
    sel.innerHTML = `<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –ø–æ—Å–∞–¥—É ‚Äî</option>` +
      POSITIONS.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  function renderEmployeesTableAndSelects(list) {
    const tbody = document.querySelector("#empTable tbody");
    tbody.innerHTML = "";
    list.forEach(emp => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${emp.id}</td><td>${emp.full_name}</td><td>${emp.nfc_uid}</td><td>${emp.is_active}</td>`;
      tr.onclick = () => loadEmployee(emp.id);
      tbody.appendChild(tr);
    });

    const sel = document.getElementById("empSelect");
    sel.innerHTML = "";
    list.forEach(emp => {
      const opt = document.createElement("option");
      opt.value = emp.id;
      opt.textContent = `${emp.id} ‚Äî ${emp.full_name}`;
      sel.appendChild(opt);
    });

    const schedEmp = document.getElementById("schedEmp");
    const keep = schedEmp.value;
    schedEmp.innerHTML = `<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å ‚Äî</option>`;
    list.forEach(emp => {
      const opt = document.createElement("option");
      opt.value = emp.id;
      opt.textContent = `${emp.id} ‚Äî ${emp.full_name}`;
      schedEmp.appendChild(opt);
    });
    if (keep) schedEmp.value = keep;
  }

  async function loadEmployees() {
    const res = await apiFetch(`/employees/`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`employees HTTP ${res.status}\n${fmtJsonError(txt)}`);
    }
    const data = await res.json();
    _employeesCache = data;
    applyEmployeeFilter();
    setStatus(!!getToken(), getToken() ? "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ" : "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
  }

  async function loadEmployee(id) {
    const res = await apiFetch(`/employees/${id}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
    }
    const emp = await res.json();
    empId.value = emp.id;
    fullName.value = emp.full_name;
    nfcUid.value = emp.nfc_uid;
    position.value = emp.position || "";
    comment.value = emp.comment || "";
    isActive.checked = !!emp.is_active;
  }

  function isEditModeOn() {
    return !!document.getElementById("editMode")?.checked;
  }

  async function saveEmployee() {
    const id = (empId.value || "").trim();

    const payload = {
      full_name: (fullName.value || "").trim() || undefined,
      nfc_uid: (nfcUid.value || "").trim() || undefined,
      position: (position.value || "").trim() || undefined,
      comment: (comment.value || "").trim() || undefined,
      is_active: isActive.checked
    };

    if (!payload.full_name || !payload.nfc_uid) {
      alert("–ü–Ü–ë —Ç–∞ NFC UID –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ.");
      return;
    }

    if (!isEditModeOn()) {
      if (!confirm(`–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞?\n\n–ü–Ü–ë: ${payload.full_name}\nNFC: ${payload.nfc_uid}\n–ü–æ—Å–∞–¥–∞: ${payload.position || "-"}`)) return;

      const res = await apiFetch(`/employees/`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`create employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }

      clearForm(true);
      await loadEmployees();
      return;
    }

    if (id) {
      if (!confirm(`–¢–æ—á–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ #${id}?\n\n–ü–Ü–ë: ${payload.full_name}\nNFC: ${payload.nfc_uid}\n–ü–æ—Å–∞–¥–∞: ${payload.position || "-"}`)) return;

      const res = await apiFetch(`/employees/${id}`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`update employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }

      await loadEmployees();
      return;
    } else {
      if (!confirm(`–°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞?\n\n–ü–Ü–ë: ${payload.full_name}\nNFC: ${payload.nfc_uid}\n–ü–æ—Å–∞–¥–∞: ${payload.position || "-"}`)) return;

      const res = await apiFetch(`/employees/`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`create employee HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }

      clearForm(true);
      await loadEmployees();
    }
  }

  function clearForm(force = false) {
    const hasData =
      (fullName.value || "").trim() ||
      (nfcUid.value || "").trim() ||
      (position.value || "").trim() ||
      (comment.value || "").trim() ||
      (empId.value || "").trim();

    if (!force && hasData) {
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É? –ù–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.")) return;
    }

    empId.value = "";
    fullName.value = "";
    nfcUid.value = "";
    position.value = "";
    comment.value = "";
    isActive.checked = true;
  }

  // ===== Step 2: Plan vs Fact =====

  function scheduleCellText(it) {
    if (!it) return "";
    if (it.code) return it.code;
    if (it.start_hhmm || it.end_hhmm) return `${it.start_hhmm || ""}-${it.end_hhmm || ""}`;
    return "";
  }

  function calcExpectedMinutesFromScheduleItem(it) {
    // Only if shift is time-based. Codes like "–í" => no planned minutes.
    if (!it || it.code) return null;
    const a = parseHHMM(it.start_hhmm);
    const b = parseHHMM(it.end_hhmm);
    if (a === null || b === null) return null;

    // allow overnight shifts (e.g. 22:00-06:00)
    let diff = b - a;
    if (diff < 0) diff += 24 * 60;
    return diff;
  }

  function buildScheduleMap(schedulePayload) {
    // Map day -> { text, start_hhmm, end_hhmm, code, expected_minutes }
    const map = new Map();
    const items = (schedulePayload && schedulePayload.items) ? schedulePayload.items : [];
    for (const it of items) {
      const day = it.day;
      map.set(day, {
        text: scheduleCellText(it),
        start_hhmm: it.start_hhmm || null,
        end_hhmm: it.end_hhmm || null,
        code: it.code || null,
        expected_minutes: calcExpectedMinutesFromScheduleItem(it)
      });
    }
    return map;
  }

  function renderEvents(events) {
    const tbody = document.querySelector("#eventsTable tbody");
    tbody.innerHTML = "";
    (events || []).forEach(e => {
      const tr = document.createElement("tr");
      const ts = e.ts_local || e.tsLocal || e.ts_utc || e.tsUtc || e.ts;
      tr.innerHTML = `
        <td>${e.id ?? ""}</td>
        <td>${String(e.direction || "").toUpperCase()}</td>
        <td>${fmtTime(ts)}</td>
        <td>${e.terminal_id ?? ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderAggregates(dailyPayload) {
    const box = document.getElementById("aggInfo");
    if (!box) return;

    if (!dailyPayload) {
      box.style.display = "none";
      box.textContent = "";
      return;
    }

    const totalMin = dailyPayload.total_minutes ?? 0;
    const totalHms = dailyPayload.total_hms ?? "";
    const weeks = dailyPayload.weeks || [];
    const months = dailyPayload.months || [];

    const weeksHtml = weeks.length
      ? weeks.map(w => `<div>‚Ä¢ ${w.week_start_local} ‚Üí ${w.week_end_local}: <b>${w.worked_hms}</b> (${w.worked_minutes} —Ö–≤)</div>`).join("")
      : "<div>‚Äî</div>";

    const monthsHtml = months.length
      ? months.map(m => `<div>‚Ä¢ ${m.month}: <b>${m.worked_hms}</b> (${m.worked_minutes} —Ö–≤)</div>`).join("")
      : "<div>‚Äî</div>";

    box.style.display = "block";
    box.innerHTML = `
      <div><b>–ü—ñ–¥—Å—É–º–æ–∫ –º—ñ—Å—è—Ü—è:</b> ${totalHms} (${totalMin} —Ö–≤)</div>
      <details style="margin-top:6px;">
        <summary>–ú—ñ—Å—è—Ü—ñ</summary>
        ${monthsHtml}
      </details>
    `;
  }

function minutesLabel(min) {
  if (min === null || min === undefined) return "‚Äî";
  if (min === 0) return "‚Äî";
  const sign = min > 0 ? "+" : "‚àí";
  const a = Math.abs(min);
  const hh = Math.floor(a / 60);
  const mm = a % 60;
  if (hh === 0) return `${sign}${mm} —Ö–≤`;
  return `${sign}${hh}–≥ ${String(mm).padStart(2,"0")}—Ö–≤`;
}

function pillNeutral(text="‚Äî") { return `<span class="pill neutral">${escapeHtml(text)}</span>`; }
function pillWarn(text) { return `<span class="pill warn">${escapeHtml(text)}</span>`; }
function pillViol(text="–ü–æ—Ä—É—à–µ–Ω–Ω—è") { return `<span class="pill viol">${escapeHtml(text)}</span>`; }
function pillGood(text) { return `<span class="pill good">${escapeHtml(text)}</span>`; }
function pillBad(text) { return `<span class="pill bad">${escapeHtml(text)}</span>`; }

function renderDailyPlanFact(dailyItems, scheduleMap) {
  const tbody = document.querySelector("#dailyTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  (dailyItems || []).forEach(r => {
    const day = r.date_local || "";
    const sch = (scheduleMap && scheduleMap.get) ? (scheduleMap.get(day) || null) : null;

    const open = !!r.open_shift;
    const autoClosed = !!r.auto_closed;
    const hasWarn = Array.isArray(r.anomalies) && r.anomalies.length > 0;

    // ===== PLAN =====
    const planText = (sch && sch.text) ? sch.text : "";
    const planMinutes = (sch && sch.expected_minutes !== undefined && sch.expected_minutes !== null)
      ? sch.expected_minutes
      : null;

    const planHtml = planText
      ? `<b>${escapeHtml(planText)}</b>${planMinutes !== null ? ` <span class="muted small">(${planMinutes} —Ö–≤)</span>` : ""}`
      : `<span class="muted small">‚Äî</span>`;

    // ===== FACT =====
    const factWorked = (r.worked_minutes !== undefined && r.worked_minutes !== null) ? r.worked_minutes : null;

    const inVal = r.first_in_local || null;
    const outVal = (!open) ? (r.last_out_local || null) : null; // ‚úÖ —Ç—É—Ç –±—É–ª–∞ –ø–æ–ª–æ–º–∫–∞ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∫–æ–¥—ñ

    const inLabel = inVal ? fmtTime(inVal) : "";
    const outLabel = outVal ? fmtTime(outVal) : "";

    let factHtml = `<span class="muted small">‚Äî</span>`;
    if (inLabel || outLabel || factWorked !== null) {
      const parts = [];
      if (inLabel || outLabel) parts.push(`${inLabel}${outLabel ? " ‚Üí " + outLabel : ""}`);
      if (r.worked_hms) parts.push(`<span class="muted small">${escapeHtml(r.worked_hms)}</span>`);
      factHtml = parts.join(" <span class='muted small'>|</span> ");
    }

    // ===== BADGES =====
    const badges = []
      .concat(open ? [`<span class="badge open">open</span>`] : [])
      .concat(autoClosed ? [`<span class="badge auto">auto</span>`] : [])
      .concat(hasWarn ? [`<span class="badge warn">warn</span>`] : [])
      .join("");

    // ===== Œî ONLY (–±–µ–∑ Late/Early/Ok) =====
    // - —è–∫—â–æ —î –ø–ª–∞–Ω —ñ —Ñ–∞–∫—Ç (—ñ –Ω–µ open) => Œî = —Ñ–∞–∫—Ç - –ø–ª–∞–Ω
    // - —è–∫—â–æ –ø–ª–∞–Ω—É –Ω–µ–º–∞, –∞–ª–µ —Ñ–∞–∫—Ç > 0 => –ø–æ–∫–∞–∑—É—î–º–æ +fact (—â–æ–± –Ω–µ –±—É–ª–æ –ø—É—Å—Ç–æ)
    // - —è–∫—â–æ 0 => –ø–æ–∫–∞–∑—É—î–º–æ —Å—ñ—Ä–µ "‚Äî"
    let deltaHtml = `<span class="pill neutral">‚Äî</span>`;

    if (!open && planMinutes !== null && factWorked !== null) {
      const delta = factWorked - planMinutes;
      if (delta > 0) deltaHtml = `<span class="pill good">+${delta} —Ö–≤</span>`;
      else if (delta < 0) deltaHtml = `<span class="pill bad">${delta} —Ö–≤</span>`;
      else deltaHtml = `<span class="pill neutral">‚Äî</span>`;
    } else if (planMinutes === null && factWorked !== null && factWorked > 0) {
      deltaHtml = `<span class="pill good">+${factWorked} —Ö–≤</span>`;
    }

    const tr = document.createElement("tr");
    if (open) tr.classList.add("row-open");
    if (hasWarn) tr.classList.add("row-warn");

    tr.innerHTML = `
      <td>${escapeHtml(day)}</td>
      <td>${planHtml}</td>
      <td>${factHtml} ${badges}</td>
      <td>${deltaHtml}</td>
    `;
    tbody.appendChild(tr);
  });
}


function dateLocalFromTsAny(ts) {
  if (!ts) return null;
  const s = String(ts).trim();

  // —è–∫—â–æ –ø—Ä–æ—Å—Ç–æ "YYYY-MM-DD" ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —è–∫ —î
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  const d = new Date(s);
  if (Number.isNaN(d.getTime())) return null;
  return ymd(d);
}

function mergeDailyWithIntervals(dailyItems, intervals, events) {
  const out = Array.isArray(dailyItems) ? [...dailyItems] : [];
  const byDay = new Map(out.map(x => [x.date_local, x]));

  // 1) —è–∫—â–æ —î intervals ‚Äî –≤–æ–Ω–∏ –Ω–∞–π–∫—Ä–∞—â—ñ –¥–ª—è ‚Äú—Ñ–∞–∫—Ç —Ö–≤–∏–ª–∏–Ω–∏‚Äù
  if (Array.isArray(intervals) && intervals.length) {
    const sumByDay = new Map();

    for (const it of intervals) {
      // –Ω–∞ —Ç–≤–æ—î–º—É –±–µ–∫–µ–Ω–¥—ñ —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ start/end/ts_start/ts_end ‚Äî –ø—ñ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
      const a = it.start_local || it.start || it.ts_start_local || it.ts_start || it.in_ts || it.in || null;
      const b = it.end_local   || it.end   || it.ts_end_local   || it.ts_end   || it.out_ts || it.out || null;

      const day = dateLocalFromTsAny(a) || dateLocalFromTsAny(b);
      if (!day) continue;

      const da = new Date(a);
      const db = new Date(b);
      if (Number.isNaN(da.getTime()) || Number.isNaN(db.getTime())) continue;

      const mins = Math.max(0, Math.round((db - da) / 60000));
      sumByDay.set(day, (sumByDay.get(day) || 0) + mins);
    }

    for (const [day, mins] of sumByDay.entries()) {
      if (!byDay.has(day)) {
        const obj = {
          date_local: day,
          worked_minutes: mins,
          worked_hms: `${Math.floor(mins/60)}:${String(mins%60).padStart(2,"0")}:00`,
          first_in_local: null,
          last_out_local: null,
          open_shift: false,
          auto_closed: false,
          anomalies: ["added_from_intervals"]
        };
        byDay.set(day, obj);
        out.push(obj);
      } else {
        // —è–∫—â–æ daily —î, –∞–ª–µ worked_minutes = 0/ null ‚Äî –º–æ–∂–Ω–∞ ‚Äú–ø—ñ–¥–ø–µ—Ä—Ç–∏‚Äù —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
        const cur = byDay.get(day);
        if ((cur.worked_minutes ?? null) === null || cur.worked_minutes === 0) {
          cur.worked_minutes = mins;
          cur.worked_hms = cur.worked_hms || `${Math.floor(mins/60)}:${String(mins%60).padStart(2,"0")}:00`;
        }
      }
    }
  }

  // 2) —è–∫—â–æ intervals –Ω–µ–º–∞ ‚Äî –∞–ª–µ events —î, –¥–æ–¥–∞—î–º–æ ‚Äú–ø–æ—Ä–æ–∂–Ω—ñ–π —Ñ–∞–∫—Ç‚Äù (—â–æ–± –¥–µ–Ω—å –Ω–µ –ø—Ä–æ–ø–∞–≤)
  if (Array.isArray(events) && events.length) {
    for (const e of events) {
      const ts = e.ts_local || e.tsLocal || e.ts_utc || e.tsUtc || e.ts;
      const day = dateLocalFromTsAny(ts);
      if (!day) continue;

      if (!byDay.has(day)) {
        const obj = {
          date_local: day,
          worked_minutes: null,     // –Ω–µ –≤–∏–≥–∞–¥—É—î–º–æ, —è–∫—â–æ –Ω–µ –º–æ–∂–µ–º–æ –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏
          worked_hms: "",
          first_in_local: null,
          last_out_local: null,
          open_shift: false,
          auto_closed: false,
          anomalies: ["has_scans_no_daily"]
        };
        byDay.set(day, obj);
        out.push(obj);
      }
    }
  }

  // —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ –¥–∞—Ç—ñ
  out.sort((a,b) => String(a.date_local).localeCompare(String(b.date_local)));
  return out;
}


function mergeDailyWithAllDays(from, to, dailyItems) {
  // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ —Ä—è–¥–æ–∫ –Ω–∞ –∫–æ–∂–µ–Ω –¥–µ–Ω—å –º—ñ—Å—è—Ü—è (28‚Äì31)
  const byDay = new Map((dailyItems || []).map(x => [x.date_local, x]));
  const out = [];
  for (const d of eachDay(from, to)) {
    const day = ymd(d);
    const existing = byDay.get(day);
    out.push(existing || {
      date_local: day,
      worked_minutes: 0,
      worked_hms: "00:00:00",
      first_in_local: null,
      last_out_local: null,
      open_shift: false,
      auto_closed: false,
      anomalies: []
    });
  }
  return out;
}



  function renderChartPlanVsFact(dailyItems, scheduleMap) {
    if (!window.Chart) return;

    const labels = (dailyItems || []).map(x => x.date_local);
    const planned = (dailyItems || []).map(x => {
      const sch = scheduleMap.get(x.date_local);
    return (sch && sch.expected_minutes !== null) ? sch.expected_minutes : null;
    });
    const fact = (dailyItems || []).map(x => {
      const v = (x.worked_minutes ?? null);
      return (v === 0 ? null : v);
    });


    const ctx = document.getElementById("chart");
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "–ü–ª–∞–Ω (—Ö–≤)", data: planned },
          { label: "–§–∞–∫—Ç (—Ö–≤)", data: fact }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  async function loadStats() {
    const empIdVal = document.getElementById("empSelect").value;
    const monthVal = document.getElementById("monthPick").value;

    if (!empIdVal) { alert("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞"); return; }
    if (!monthVal) { alert("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å"); return; }

    const range = monthToRange(monthVal);
    if (!range) { alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –º—ñ—Å—è—Ü—å"); return; }

    document.getElementById("rangePreview").value = `${range.from} ‚Üí ${range.to}`;

    // 1) events overview (for table) ‚Äî keep as before
let s1 = { events: [], intervals: [], has_open_shift: false };

const res1 = await apiFetch(`/stats/employee/${empIdVal}`);
if (res1.ok) {
  s1 = await res1.json();
} else if (res1.status === 404) {
  // ‚úÖ –ù–û–†–ú–ê–õ–¨–ù–û: —É –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ –Ω–µ–º–∞ –ø–æ–¥—ñ–π
  const payload = await safeJson(res1);
  console.warn("No events (404):", payload);
  s1 = { events: [], intervals: [], has_open_shift: false };
} else {
  const txt = await res1.text().catch(() => "");
  throw new Error(`stats employee HTTP ${res1.status}\n${fmtJsonError(txt)}`);
}

renderEvents(s1.events || []);


    // 2) daily truth for month
let s2 = null;

const res2 = await apiFetch(`/stats/employee/${empIdVal}/daily?from_date=${encodeURIComponent(range.from)}&to_date=${encodeURIComponent(range.to)}`);

if (res2.ok) {
  s2 = await res2.json();
} else if (res2.status === 404) {
  // ‚úÖ –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ —Ç–µ–∂ –¥–∞—î 404 –Ω–∞ daily –±–µ–∑ –ø–æ–¥—ñ–π ‚Äî —Ä–æ–±–∏–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –º—ñ—Å—è—Ü—å
  const payload = await safeJson(res2);
  console.warn("No daily (404):", payload);
  s2 = makeEmptyDaily(range.from, range.to);
} else {
  const txt = await res2.text().catch(() => "");
  throw new Error(`stats daily HTTP ${res2.status}\n${fmtJsonError(txt)}`);
}


    // 3) schedule for same month (plan)
    const q = new URLSearchParams();
    q.set("date_from", range.from);
    q.set("date_to", range.to);
    q.set("employee_id", String(empIdVal));

    const res3 = await apiFetch(`/schedule?${q.toString()}`);
    if (!res3.ok) {
      const txt = await res3.text().catch(() => "");
      throw new Error(`schedule HTTP ${res3.status}\n${fmtJsonError(txt)}`);
    }
    const sched = await res3.json();
    const scheduleMap = buildScheduleMap(sched);

    // UI
    document.getElementById("statsInfo").textContent =
      `–ü–æ–¥—ñ—ó: ${(s1.events || []).length} | –Ü–Ω—Ç–µ—Ä–≤–∞–ª–∏: ${(s1.intervals || []).length} | –£—Å—å–æ–≥–æ: ${s2.total_hms || (s2.total_minutes + " —Ö–≤")} | open_shift: ${!!s1.has_open_shift}`;

        const mergedItems = mergeDailyWithIntervals(s2.items || [], (s1.intervals || []), (s1.events || []));
        renderAggregates(s2);
        const allDaysItems = mergeDailyWithAllDays(range.from, range.to, s2.items || []);
        renderDailyPlanFact(allDaysItems, scheduleMap);
        renderChartPlanVsFact(allDaysItems, scheduleMap);



    setStatus(true, "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
  }

  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  // ===== Schedule (unchanged logic from your previous) =====
  const schedMode = document.getElementById("schedMode");
  const schedEmp  = document.getElementById("schedEmp");
  const schedFrom = document.getElementById("schedFrom");
  const schedTo   = document.getElementById("schedTo");

  function parseYmd(s) {
    const parts = String(s || "").split("-").map(Number);
    if (parts.length !== 3 || parts.some(n => !Number.isFinite(n))) return new Date();
    const [y, m, d] = parts;
    return new Date(y, m - 1, d);
  }

  function eachDay(fromStr, toStr) {
    const out = [];
    let cur = parseYmd(fromStr);
    const end = parseYmd(toStr);
    while (cur <= end) {
      out.push(new Date(cur));
      cur.setDate(cur.getDate() + 1);
    }
    return out;
  }

  function normalizeScheduleCell(v) {
    const s = (v || "").trim();
    if (!s) return { code: null, start_hhmm: null, end_hhmm: null };
    const m = s.match(/^(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})$/);
    if (m) return { code: null, start_hhmm: m[1], end_hhmm: m[2] };
    return { code: s, start_hhmm: null, end_hhmm: null };
  }

  function onScheduleModeChange() {
    const mode = schedMode.value;
    document.getElementById("scheduleWideBox").style.display = (mode === "all") ? "block" : "none";
    document.getElementById("scheduleMatrixBox").style.display = (mode === "single") ? "block" : "none";
  }

  async function loadSchedule() {
    const mode = schedMode.value;
    const from = schedFrom.value;
    const to = schedTo.value;
    const empId = Number(schedEmp.value || 0);

    if (!from) { alert("–í–∫–∞–∂—ñ—Ç—å from_date"); return; }
    if (mode === "all" && !to) { alert("–í–∫–∞–∂—ñ—Ç—å to_date"); return; }
    if (mode === "single" && !empId) { alert("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞"); return; }

    if (mode === "single") {
      const dt = parseYmd(from);
      const monthStart = new Date(dt.getFullYear(), dt.getMonth(), 1);
      const monthEnd = new Date(dt.getFullYear(), dt.getMonth() + 1, 0);

      const q = new URLSearchParams();
      q.set("date_from", ymd(monthStart));
      q.set("date_to", ymd(monthEnd));
      q.set("employee_id", String(empId));

      const res = await apiFetch(`/schedule?${q.toString()}`);
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`schedule HTTP ${res.status}\n${fmtJsonError(txt)}`);
      }
      const data = await res.json();

      const map = new Map();
      for (const it of (data.items || [])) {
        map.set(`${it.employee_id}|${it.day}`, scheduleCellText(it));
      }

      renderScheduleMatrix(empId, monthStart, monthEnd, map);
      // ‚úÖ sync: –ø—ñ–¥—Å—Ç–∞–≤–∏–º–æ –≤ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" —Ç–æ–≥–æ –∂ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ —ñ –º—ñ—Å—è—Ü—å
        try {
          const empSelect = document.getElementById("empSelect");
          const monthPick = document.getElementById("monthPick");
          const rangePreview = document.getElementById("rangePreview");
        
          if (empSelect) empSelect.value = String(empId);
        
          const yyyy = monthStart.getFullYear();
          const mm = String(monthStart.getMonth() + 1).padStart(2, "0");
          const mval = `${yyyy}-${mm}`;
          if (monthPick) monthPick.value = mval;
        
          if (rangePreview) rangePreview.value = `${ymd(monthStart)} ‚Üí ${ymd(monthEnd)}`;
        
          // –Ø–∫—â–æ —Ö–æ—á–µ—à ‚Äú—Å—É–ø–µ—Ä-–≤–∞—É‚Äù: –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–¥—Ä–∞–∑—É:
          // await loadStats();
        } catch (e) {
          console.warn("schedule->stats sync skipped:", e);
        }

      document.getElementById("matrixHint").textContent =
        `${monthStart.toLocaleString("uk", { month: "long" })} ${monthStart.getFullYear()}`;
      return;
    }

    const q = new URLSearchParams();
    q.set("date_from", from);
    q.set("date_to", to);

    const res = await apiFetch(`/schedule?${q.toString()}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`schedule HTTP ${res.status}\n${fmtJsonError(txt)}`);
    }
    const data = await res.json();

    const map = new Map();
    for (const it of (data.items || [])) {
      map.set(`${it.employee_id}|${it.day}`, scheduleCellText(it));
    }

    const employees = document.getElementById("empSearch")?.value?.trim()
      ? (function(){
          const q2 = document.getElementById("empSearch").value.trim().toLowerCase();
          return _employeesCache.filter(e => {
            const hay = [e.id,e.full_name,e.nfc_uid,e.position,e.comment].filter(Boolean).join(" ").toLowerCase();
            return hay.includes(q2);
          });
        })()
      : _employeesCache;

    renderScheduleWideTable(employees, from, to, map);
  }

  function renderScheduleWideTable(employees, from, to, map) {
    const days = eachDay(from, to);
    const thead = document.querySelector("#scheduleWideTable thead");
    const tbody = document.querySelector("#scheduleWideTable tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th style="min-width:40px;">‚Ññ</th>
      <th style="min-width:220px;">–ü–Ü–ë</th>
      <th style="min-width:160px;">–ü–æ—Å–∞–¥–∞</th>
      ${days.map(d => `<th style="min-width:60px;">${String(d.getDate()).padStart(2,"0")}</th>`).join("")}
    `;
    thead.appendChild(trh);

    employees.forEach((e, idx) => {
      const tr = document.createElement("tr");
      const cols = [];
      cols.push(`<td style="text-align:center;">${idx + 1}</td>`);
      cols.push(`<td>${e.full_name}</td>`);
      cols.push(`<td>${e.position || ""}</td>`);

      for (const d of days) {
        const dayStr = ymd(d);
        const key = `${e.id}|${dayStr}`;
        const val = map.get(key) || "";
        cols.push(`<td>${val}</td>`);
      }

      tr.innerHTML = cols.join("");
      tbody.appendChild(tr);
    });
  }

  function renderScheduleMatrix(employeeId, monthStart, monthEnd, map) {
    const thead = document.querySelector("#scheduleMatrix thead");
    const tbody = document.querySelector("#scheduleMatrix tbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th style="min-width:92px;">1</th>
      <th style="min-width:92px;">2</th>
      <th style="min-width:92px;">3</th>
      <th style="min-width:92px;">4</th>
      <th style="min-width:92px;">5</th>
      <th style="min-width:92px;">6</th>
      <th style="min-width:92px;">7</th>
    `;
    thead.appendChild(trh);

const daysInMonth = monthEnd.getDate();
    const rows = Math.ceil(daysInMonth / 7);

    let day = 1;
    for (let r = 0; r < rows; r++) {
      const tr = document.createElement("tr");

      for (let c = 0; c < 7; c++) {
        if (day <= daysInMonth) {
          const d = new Date(monthStart.getFullYear(), monthStart.getMonth(), day);
          const dayStr = ymd(d);
          const key = `${employeeId}|${dayStr}`;
          const val = map.get(key) || "";

          const td = document.createElement("td");
          td.className = "matrix-cell";
          td.dataset.emp = String(employeeId);
          td.dataset.day = dayStr;
          td.onclick = () => editScheduleMatrixCell(td);

          td.innerHTML = `
            <div class="daynum">
              <span>${day}</span>
              <span class="muted small">${dayStr}</span>
            </div>
            <div class="shifttext">${val || ""}</div>
          `;
          tr.appendChild(td);
          day++;
        } else {
          const td = document.createElement("td");
          td.className = "empty";
          td.innerHTML = `‚Äî`;
          tr.appendChild(td);
        }
      }

      tbody.appendChild(tr);
    }
  }


function buildCellPayloadV1(empId, day, n) {
  // V1 (–Ω–æ–≤–∏–π): employee_id + day + (code OR start/end)
  const payload = { employee_id: Number(empId), day: String(day) };

  if (n.code) {
    payload.code = String(n.code);
  } else if (n.start_hhmm || n.end_hhmm) {
    if (n.start_hhmm) payload.start_hhmm = String(n.start_hhmm);
    if (n.end_hhmm) payload.end_hhmm = String(n.end_hhmm);
  } else {
    // "–≤–∏–¥–∞–ª–∏—Ç–∏" ‚Äî –Ω–µ —à–ª–µ–º–æ start/end/code —è–∫ null
    // (–±–µ–∫ –º–æ–∂–µ –º–∞—Ç–∏ –æ–∫—Ä–µ–º–∏–π —Ñ–ª–∞–≥ delete; —è–∫—â–æ —Ç—Ä–µ–±–∞ ‚Äî –¥–æ–¥–∞—Å–∏ –Ω–∏–∂—á–µ)
  }

  return payload;
}

function buildCellPayloadLegacy(empId, day, n) {
  // Legacy (—Å—Ç–∞—Ä–∏–π): employee_id + day + value (—Ä—è–¥–æ–∫ "07:00-19:00" –∞–±–æ "–í" –∞–±–æ "")
  const text =
    n.code ? String(n.code) :
    (n.start_hhmm || n.end_hhmm) ? `${n.start_hhmm || ""}-${n.end_hhmm || ""}` :
    ""; // empty = delete

  return { employee_id: Number(empId), day: String(day), value: text };
}

function buildCellPayloadAltDate(empId, day, n) {
  // Variant: –±–µ–∫ –º–æ–∂–µ —á–µ–∫–∞—Ç–∏ date –∑–∞–º—ñ—Å—Ç—å day
  const base = buildCellPayloadV1(empId, day, n);
  delete base.day;
  base.date = String(day);
  return base;
}

async function postScheduleCellSmart(empId, day, n) {
  const attempts = [
    { name: "V1(day,start/end,code)", payload: buildCellPayloadV1(empId, day, n) },
    { name: "ALT(date,start/end,code)", payload: buildCellPayloadAltDate(empId, day, n) },
    { name: "LEGACY(value)", payload: buildCellPayloadLegacy(empId, day, n) },
  ];

  let lastErrText = "";
  for (const a of attempts) {
    const clean = stripNulls(a.payload);           // ‚úÖ –∫–ª—é—á–æ–≤–∏–π –º–æ–º–µ–Ω—Ç
    console.log("[schedule/cell] try:", a.name, clean);

    const res = await apiFetch(`/schedule/cell`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(clean),
    });

    if (res.ok) return { ok: true, used: a.name };

    const txt = await res.text().catch(() => "");
    lastErrText = `Try=${a.name}\nHTTP ${res.status}\n${txt}`;
    if (res.status !== 400) break;
  }

  return { ok: false, error: lastErrText };
}


// === –ó–ê–ú–Ü–ù–ò –¢–Ü–õ–û editScheduleMatrixCell –ù–ê –¶–ï (–∞–±–æ –ø—ñ–¥–∫–ª—é—á–∏ –≤–∏–∫–ª–∏–∫) ===
async function editScheduleMatrixCell(td) {
  const empId = Number(td.dataset.emp);
  const day = td.dataset.day;
  const cur = td.querySelector(".shifttext")?.textContent?.trim() || "";

  const input = prompt(
    `–ó–º—ñ–Ω–∞ –Ω–∞ ${day}\n\n–í–≤–µ–¥—ñ—Ç—å:\n- HH:MM-HH:MM (07:00-19:00)\n- –∞–±–æ –∫–æ–¥ (–í, –í—ñ–¥—Ä., –ù)\n- –ø–æ—Ä–æ–∂–Ω—å–æ = –≤–∏–¥–∞–ª–∏—Ç–∏`,
    cur
  );
  if (input === null) return;

  const n = normalizeScheduleCell(input);

  const r = await postScheduleCellSmart(empId, day, n);
  if (!r.ok) {
    alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–ª—ñ—Ç–∏–Ω–∫–∏ (–±–µ–∫ –Ω–µ –ø—Ä–∏–π–Ω—è–≤ payload):\n\n" + r.error);
    return;
  }

  // UI update
  const text =
    n.code ? n.code :
    (n.start_hhmm || n.end_hhmm) ? `${n.start_hhmm || ""}-${n.end_hhmm || ""}` :
    "";
  td.querySelector(".shifttext").textContent = text;

  console.log("[schedule/cell] saved via:", r.used);
}

  async function openSchedulePdf() {
    const mode = schedMode.value;
    let from = schedFrom.value;
    let to = schedTo.value;

    if (!from) { alert("–í–∫–∞–∂—ñ—Ç—å from_date"); return; }

    if (mode === "single") {
      const dt = parseYmd(from);
      const monthStart = new Date(dt.getFullYear(), dt.getMonth(), 1);
      const monthEnd = new Date(dt.getFullYear(), dt.getMonth() + 1, 0);
      from = ymd(monthStart);
      to = ymd(monthEnd);
    } else {
      if (!to) { alert("–í–∫–∞–∂—ñ—Ç—å to_date"); return; }
    }

    const res = await apiFetch(`/schedule/pdf?date_from=${encodeURIComponent(from)}&date_to=${encodeURIComponent(to)}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      alert(`–ü–æ–º–∏–ª–∫–∞ PDF: HTTP ${res.status}\n${fmtJsonError(txt)}`);
      return;
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
  }

  // ===== INIT =====

  function initScheduleDates() {
    const now = new Date();
    const first = new Date(now.getFullYear(), now.getMonth(), 1);
    const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    schedFrom.value = ymd(first);
    schedTo.value = ymd(last);
  }

  function initMonthPicker() {
    const mp = document.getElementById("monthPick");
    const prev = document.getElementById("rangePreview");
    if (!mp || !prev) return;

    // default: current month
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    mp.value = `${y}-${m}`;

    const r = monthToRange(mp.value);
    prev.value = r ? `${r.from} ‚Üí ${r.to}` : "";

    mp.addEventListener("change", () => {
      const r2 = monthToRange(mp.value);
      prev.value = r2 ? `${r2.from} ‚Üí ${r2.to}` : "";
    });
  }

  initPositionSelect();
  initScheduleDates();
  onScheduleModeChange();
  initMonthPicker();

  (async () => {
    const token = getToken();
    if (!token) {
      setStatus(false, "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
      openLogin();
      return;
    }
    try {
      await loadEmployees();
      setStatus(true, "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ");
    } catch (e) {
      console.error(e);
      setStatus(false, "–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π/–ø–æ–º–∏–ª–∫–∞");
      openLogin();
    }
  })();
  
  
  
  
  
  
  
  
// ======================= PLAN BUILDER (Chart page) =======================
let pbEmployeesFiltered = [];
let pbSelected = new Set();      // selected day keys: "YYYY-MM-DD"
let pbScheduleMap = new Map();   // day -> {text,start_hhmm,end_hhmm,code}
let pbMonthRange = null;         // {from,to, y, m}
let pbCurrentEmpId = null;

function openPlanBuilder() {
  document.getElementById("planBackdrop").classList.add("show");
  pbInit();
}

function closePlanBuilder() {
  document.getElementById("planBackdrop").classList.remove("show");
}

function pbInit() {
  // fill employee dropdown from existing cache
  pbEmployeesFiltered = Array.isArray(_employeesCache) ? [..._employeesCache] : [];
  pbRenderEmpSelect();

  // default month = current month
  const m = document.getElementById("pbMonth");
  if (m && !m.value) {
    const now = new Date();
    m.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,"0")}`;
  }

  pbSelected.clear();
  pbCurrentEmpId = null;
  pbScheduleMap = new Map();
  pbMonthRange = null;

  pbLoadMonth(); // renders empty month grid (until emp chosen / server loaded)
}

function pbRenderEmpSelect() {
  const sel = document.getElementById("pbEmpSelect");
  const keep = sel.value;
  sel.innerHTML = "";

  (pbEmployeesFiltered || []).forEach(e => {
    const opt = document.createElement("option");
    opt.value = String(e.id);
    opt.textContent = `${e.id} ‚Äî ${e.full_name}`;
    sel.appendChild(opt);
  });

  if (keep) sel.value = keep;
}

function pbApplyFilter() {
  const q = (document.getElementById("pbSearch")?.value || "").trim().toLowerCase();
  pbEmployeesFiltered = !q ? [..._employeesCache] : _employeesCache.filter(e => {
    const hay = [e.id, e.full_name, e.nfc_uid, e.position, e.comment].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  });
  pbRenderEmpSelect();
}

function pbOnEmpPicked() {
  const sel = document.getElementById("pbEmpSelect");
  pbCurrentEmpId = sel && sel.value ? Number(sel.value) : null;
  pbReloadFromServer();
}

function pbMonthToRange(monthStr) {
  const [y, m] = String(monthStr || "").split("-").map(Number);
  if (!y || !m) return null;
  const last = new Date(y, m, 0).getDate();
  return { from: `${y}-${String(m).padStart(2,"0")}-01`, to: `${y}-${String(m).padStart(2,"0")}-${String(last).padStart(2,"0")}`, y, m };
}

function pbLoadMonth() {
  const monthVal = document.getElementById("pbMonth")?.value || "";
  pbMonthRange = pbMonthToRange(monthVal);
  pbSelected.clear();
  pbRenderMatrix();
}

function pbReloadFromServer() {
  if (!pbCurrentEmpId) {
    pbSetInfo("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞.");
    pbRenderMatrix();
    return;
  }
  if (!pbMonthRange) {
    pbSetInfo("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å.");
    pbRenderMatrix();
    return;
  }
  pbFetchScheduleForMonth(pbCurrentEmpId, pbMonthRange.from, pbMonthRange.to);
}

function pbSetInfo(msg) {
  const el = document.getElementById("pbInfo");
  if (el) el.textContent = msg;
}

async function pbFetchScheduleForMonth(empId, from, to) {
  try {
    pbSetInfo("–ó–∞–≤–∞–Ω—Ç–∞–∂—É—é —Ä–æ–∑–∫–ª–∞–¥ –∑ —Å–µ—Ä–≤–µ—Ä–∞...");
    const q = new URLSearchParams();
    q.set("employee_id", String(empId));
    q.set("date_from", from);
    q.set("date_to", to);

    const res = await apiFetch(`/schedule?${q.toString()}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      pbSetInfo(`–ü–æ–º–∏–ª–∫–∞ /schedule: HTTP ${res.status} ${fmtJsonError(txt)}`);
      pbScheduleMap = new Map();
      pbRenderMatrix();
      return;
    }

    const data = await res.json();
    pbScheduleMap = new Map();
    for (const it of (data.items || [])) {
      pbScheduleMap.set(it.day, {
        text: scheduleCellText(it),
        start_hhmm: it.start_hhmm || null,
        end_hhmm: it.end_hhmm || null,
        code: it.code || null
      });
    }

    pbSetInfo("–û–∫. –í–∏–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–π—Ç–µ —á–∞—Å/–≤–∏—Ö—ñ–¥–Ω–∏–π.");
    pbRenderMatrix();
  } catch (e) {
    pbSetInfo(`–ü–æ–º–∏–ª–∫–∞: ${String(e?.message || e)}`);
    pbScheduleMap = new Map();
    pbRenderMatrix();
  }
}

function pbRenderMatrix() {
  const thead = document.querySelector("#pbMatrix thead");
  const tbody = document.querySelector("#pbMatrix tbody");
  if (!thead || !tbody) return;

  thead.innerHTML = "";
  tbody.innerHTML = "";

  // header: 7 columns
  const trh = document.createElement("tr");
  trh.innerHTML = `
    <th style="min-width:98px;">–ü–Ω</th>
    <th style="min-width:98px;">–í—Ç</th>
    <th style="min-width:98px;">–°—Ä</th>
    <th style="min-width:98px;">–ß—Ç</th>
    <th style="min-width:98px;">–ü—Ç</th>
    <th style="min-width:98px;">–°–±</th>
    <th style="min-width:98px;">–ù–¥</th>
  `;
  thead.appendChild(trh);

  if (!pbMonthRange) return;

  const y = pbMonthRange.y;
  const m1 = pbMonthRange.m;
  const daysTotal = new Date(y, m1, 0).getDate();

  // Compute first day offset (Mon=0..Sun=6)
  // JS: getDay() Sun=0..Sat=6. Convert to Mon=0..Sun=6
  const first = new Date(y, m1 - 1, 1);
  const firstDow = (first.getDay() + 6) % 7;

  const totalCells = firstDow + daysTotal;
  const rows = Math.ceil(totalCells / 7);

  let day = 1;
  for (let r = 0; r < rows; r++) {
    const tr = document.createElement("tr");

    for (let c = 0; c < 7; c++) {
      const cellIndex = r * 7 + c;

      if (cellIndex < firstDow || day > daysTotal) {
        const td = document.createElement("td");
        td.className = "empty";
        td.textContent = "‚Äî";
        tr.appendChild(td);
        continue;
      }

      const dateStr = `${y}-${String(m1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      const sch = pbScheduleMap.get(dateStr) || null;

      const selected = pbSelected.has(dateStr);
      const td = document.createElement("td");
      td.className = "pb-cell" + (selected ? " selected" : "");
      td.dataset.day = dateStr;
      td.onclick = () => pbToggleDay(dateStr);

      const text = sch ? (sch.text || "") : "";
      const shiftLabel = text ? escapeHtml(text) : "‚Äî";
      const muted0 = (!text || text === "0" || text === "00:00-00:00") ? "muted0" : "";

      td.innerHTML = `
        <div class="pb-check">${selected ? "‚úì" : ""}</div>
        <div class="daynum"><span>${day}</span><span class="muted small">${dateStr}</span></div>
        <div class="pb-shift ${muted0}">${shiftLabel}</div>
      `;

      tr.appendChild(td);
      day++;
    }

    tbody.appendChild(tr);
  }
}

function pbToggleDay(dayStr) {
  if (pbSelected.has(dayStr)) pbSelected.delete(dayStr);
  else pbSelected.add(dayStr);
  pbRenderMatrix();
}

function pbSelectAll() {
  if (!pbMonthRange) return;
  const { y, m } = pbMonthRange;
  const last = new Date(y, m, 0).getDate();
  pbSelected.clear();
  for (let d = 1; d <= last; d++) {
    pbSelected.add(`${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`);
  }
  pbRenderMatrix();
}

function pbClearSelection() {
  pbSelected.clear();
  pbRenderMatrix();
}

function pbValidHHMM(v) {
  const m = String(v || "").match(/^(\d{2}):(\d{2})$/);
  if (!m) return false;
  const hh = Number(m[1]), mm = Number(m[2]);
  return hh >= 0 && hh <= 23 && mm >= 0 && mm <= 59;
}

function pbApplyToSelected() {
  if (!pbSelected.size) { pbSetInfo("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ."); return; }

  const isDayOff = !!document.getElementById("pbDayOff")?.checked;
  const start = (document.getElementById("pbStart")?.value || "").trim();
  const end = (document.getElementById("pbEnd")?.value || "").trim();

  if (!isDayOff) {
    if (!pbValidHHMM(start) || !pbValidHHMM(end)) {
      pbSetInfo("–í–∫–∞–∂—ñ—Ç—å –≤–∞–ª—ñ–¥–Ω–∏–π —á–∞—Å HH:MM –¥–ª—è —Å—Ç–∞—Ä—Ç—É —Ç–∞ –∫—ñ–Ω—Ü—è, –∞–±–æ —É–≤—ñ–º–∫–Ω—ñ—Ç—å ‚Äú–≤–∏—Ö—ñ–¥–Ω–∏–π‚Äù.");
      return;
    }
  }

  // Apply locally (without saving yet)
  for (const dayStr of pbSelected) {
    if (isDayOff) {
      pbScheduleMap.set(dayStr, { text: "–í", start_hhmm: null, end_hhmm: null, code: "–í" });
    } else {
      pbScheduleMap.set(dayStr, { text: `${start}-${end}`, start_hhmm: start, end_hhmm: end, code: null });
    }
  }

  pbSetInfo("–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ‚Äú–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä‚Äù.");
  pbRenderMatrix();
}

function pbClearSelectedCells() {
  if (!pbSelected.size) { pbSetInfo("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –¥–Ω—ñ."); return; }
  for (const dayStr of pbSelected) {
    pbScheduleMap.delete(dayStr);
  }
  pbSetInfo("–û—á–∏—Å—Ç–∏–≤ –ª–æ–∫–∞–ª—å–Ω–æ (–ø–æ—Ç—Ä—ñ–±–Ω–æ ‚Äú–ó–±–µ—Ä–µ–≥—Ç–∏‚Äù, —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ).");
  pbRenderMatrix();
}

async function pbSaveSelected() {
  if (!pbCurrentEmpId) { pbSetInfo("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞."); return; }
  if (!pbSelected.size) { pbSetInfo("–ù–µ–º–∞ –≤–∏–±—Ä–∞–Ω–∏—Ö –¥–Ω—ñ–≤."); return; }
  if (!pbMonthRange) { pbSetInfo("–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å."); return; }

  pbSetInfo("–ó–±–µ—Ä—ñ–≥–∞—é...");

  // 1) Save all selected days via smart poster
  for (const dayStr of pbSelected) {
    const it = pbScheduleMap.get(dayStr) || null;

    // —Ñ–æ—Ä–º—É—î–º–æ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É —è–∫ —É –º–∞—Ç—Ä–∏—Ü—ñ:
    const n = it
      ? { code: it.code || null, start_hhmm: it.start_hhmm || null, end_hhmm: it.end_hhmm || null }
      : { code: null, start_hhmm: null, end_hhmm: null }; // delete

    const r = await postScheduleCellSmart(pbCurrentEmpId, dayStr, n);
    if (!r.ok) {
      pbSetInfo(`–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ${dayStr}:\n${r.error}`);
      return;
    }
  }

  // 2) Verify: fetch schedule back from server (—Ü–µ ‚Äú–ø—Ä–∞–≤–¥–∞‚Äù –ø—Ä–æ –ë–î)
  try {
    const q = new URLSearchParams();
    q.set("employee_id", String(pbCurrentEmpId));
    q.set("date_from", pbMonthRange.from);
    q.set("date_to", pbMonthRange.to);

    const res = await apiFetch(`/schedule?${q.toString()}`);
    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      pbSetInfo(`–ó–±–µ—Ä–µ–∂–µ–Ω–æ, –∞–ª–µ verify /schedule –Ω–µ –ø—Ä–æ–π—à–æ–≤: HTTP ${res.status}\n${fmtJsonError(txt)}`);
      return;
    }

    const data = await res.json();
    const count = (data.items || []).length;

    // –æ–Ω–æ–≤–∏–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π map –∑ —Ç–∏–º, —â–æ —Ä–µ–∞–ª—å–Ω–æ –≤ –ë–î
    pbScheduleMap = new Map();
    for (const it of (data.items || [])) {
      pbScheduleMap.set(it.day, {
        text: scheduleCellText(it),
        start_hhmm: it.start_hhmm || null,
        end_hhmm: it.end_hhmm || null,
        code: it.code || null
      });
    }
    pbRenderMatrix();

    pbSetInfo(`–ó–±–µ—Ä–µ–∂–µ–Ω–æ. –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –∑–∞–ø–∏—Å—ñ–≤ –∑–∞ –º—ñ—Å—è—Ü—å: ${count}. –û–Ω–æ–≤–ª—é—é Plan vs Fact...`);
  } catch (e) {
    pbSetInfo(`–ó–±–µ—Ä–µ–∂–µ–Ω–æ, –∞–ª–µ verify –≤–ø–∞–≤: ${String(e?.message || e)}`);
  }

  await refreshChartOnly();
}


async function refreshChartOnly() {
  // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–æ: —è–∫—â–æ —É —Ç–µ–±–µ –≤–∂–µ —î loadStats() –¥–ª—è –º—ñ—Å—è—Ü—è ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–ª–∏—á —ó—ó.
  // –¢—É—Ç —Ä–æ–±–∏–º–æ –±–µ–∑–ø–µ—á–Ω–∏–π –≤–∏–∫–ª–∏–∫, —â–æ–± –Ω–µ –ª–∞–º–∞—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.
  try {
    if (typeof loadStats === "function") {
      await loadStats();
    } else {
      const ci = document.getElementById("chartInfo");
      if (ci) ci.textContent = "loadStats() –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –≥—Ä–∞—Ñ—ñ–∫ –¥–æ –≤–∞—à–æ—ó –ª–æ–≥—ñ–∫–∏ Plan vs Fact.";
    }
  } catch (e) {
    const ci = document.getElementById("chartInfo");
    if (ci) ci.textContent = `–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞: ${String(e?.message || e)}`;
  }
}



</script>

</body>
</html>
